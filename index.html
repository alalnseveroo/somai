<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Somai - Login</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 5 a 20 20 0 0 1 0 40 a 20 20 0 0 1 0 -40 M20 95 a 20 20 0 0 1 0 -40 a 20 20 0 0 1 0 40 M80 95 a 20 20 0 0 1 0 -40 a 20 20 0 0 1 0 40' fill='%234f46e5' /></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase Client -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@0.378.0/dist/umd/lucide.js"></script>
    
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; /* slate-50 */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type='number'] { -moz-appearance: textfield; }
        
        /* Toast Animation */
        @keyframes fadeInOut { 0%, 100% { opacity: 0; transform: translateY(-20px); } 10%, 90% { opacity: 1; transform: translateY(0); } }
        .toast { animation: fadeInOut 4s ease-in-out forwards; }

        /* Sale Notification Animation */
        @keyframes slide-in-out {
          0% { transform: translate(-50%, -150%); opacity: 0; }
          10% { transform: translate(-50%, 0); opacity: 1; }
          90% { transform: translate(-50%, 0); opacity: 1; }
          100% { transform: translate(-50%, -150%); opacity: 0; }
        }
        #sale-notification.show {
            display: flex;
            animation: slide-in-out 3s ease-in-out forwards;
        }
        
        /* Active Link Style */
        .active-link { 
            background-color: #f1f5f9; /* slate-100 */
            color: #0f172a; /* slate-900 */
            font-weight: 600; /* semibold */
        }
        .active-link i {
            color: #4f46e5; /* indigo-600 */
        }
        
        /* Loader Animation */
        .loader { border: 4px solid #e2e8f0; /* slate-200 */ border-top: 4px solid #4f46e5; /* indigo-600 */ border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pointer-events-none { pointer-events: none; }

        /* Modal Animation */
        .modal-container.open {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content.open {
             transform: scale(1);
             opacity: 1;
        }
        .modal-container {
             transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        #order-creation-modal .modal-content {
             width: calc(100% - 60px);
             height: calc(100% - 60px);
             max-width: 1600px;
        }

        /* Toggle Switch Style */
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6; /* blue-500 */
        }
        .toggle-checkbox:checked + .toggle-label::after {
            transform: translateX(100%);
        }
        #internal-consumption-toggle:checked + .toggle-label {
            background-color: #4f46e5; /* indigo-600 */
        }
        .toggle-view-checkbox:checked + .toggle-view-label {
            background-color: #16a34a; /* green-600 */
        }
        .toggle-view-checkbox:checked + .toggle-view-label .dot {
            transform: translateX(100%);
        }

        /* Notification Bell Animation */
        @keyframes ring {
            0%, 100% { transform: rotate(0); }
            10%, 90% { transform: rotate(15deg); }
            20%, 80% { transform: rotate(-10deg); }
            30%, 70% { transform: rotate(10deg); }
            40%, 60% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }
        .has-notification .bell-icon {
            animation: ring 1s ease-in-out;
        }
        
        .avatar-option.selected {
            outline: 3px solid #4f46e5;
            outline-offset: 2px;
        }
        
        /* Support Chat Popup */
        #support-chat-popup {
            transition: all 0.3s ease-in-out;
        }
        .chat-message-somia {
            background-color: #eef2ff; /* indigo-50 */
            align-self: flex-start;
        }
        .chat-message-user {
            background-color: #f1f5f9; /* slate-100 */
            align-self: flex-end;
        }
         @keyframes typing-dot {
            0% { transform: translateY(0); }
            25% { transform: translateY(-3px); }
            50% { transform: translateY(0); }
        }
        .typing-indicator span {
            animation: typing-dot 1.2s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        /* Custom Login Page Styles */
        #auth-container {
            background-color: #f0f4ff;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253, 100%, 95%, 1) 0px, transparent 50%),
                radial-gradient(at 98% 1%, hsla(22, 100%, 93%, 1) 0px, transparent 50%),
                radial-gradient(at 79% 40%, hsla(211, 100%, 89%, 1) 0px, transparent 50%),
                radial-gradient(at 2% 99%, hsla(334, 100%, 91%, 1) 0px, transparent 50%);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-700">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-100 bg-opacity-75 flex items-center justify-center z-[100] transition-opacity duration-300 hidden">
        <div class="loader"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl z-50 hidden">
        <p id="toast-message" class="text-sm"></p>
    </div>
    
    <!-- Sale Notification -->
    <div id="sale-notification" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-gradient-to-br from-green-400 to-green-500 text-white py-3 px-5 rounded-xl shadow-2xl z-[60] items-center gap-3">
        <i data-lucide="dollar-sign" class="w-8 h-8 bg-white/20 p-1.5 rounded-full"></i>
        <div>
            <p class="font-bold text-base">Saiu mais uma!</p>
            <p id="sale-value" class="text-sm"></p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 text-center transition-all duration-300 transform scale-95 opacity-0">
            <h3 id="confirm-title" class="text-base font-bold text-slate-800"></h3>
            <p id="confirm-message" class="text-slate-500 text-sm mt-2 mb-6"></p>
            <div class="grid grid-cols-2 gap-4">
                <button id="confirm-cancel-btn" class="bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 transition-colors text-sm">Cancelar</button>
                <button id="confirm-action-btn" class="bg-red-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-red-700 transition-colors text-sm">Confirmar</button>
            </div>
        </div>
    </div>


    <!-- Container da Autenticação -->
    <div id="auth-container" class="min-h-screen flex flex-col items-center justify-center p-4 relative">
        <div class="absolute top-8 flex items-center gap-2">
            <div class="bg-slate-900 p-2 rounded-lg">
                <i data-lucide="gem" class="w-5 h-5 text-white"></i>
            </div>
            <span class="font-bold text-lg text-slate-800">Somai</span>
        </div>

        <div class="w-full max-w-3xl bg-white/70 backdrop-blur-xl rounded-2xl shadow-2xl flex overflow-hidden">
            <!-- Left Panel (Form) -->
            <div class="w-full md:w-1/2 p-8 sm:p-12 flex flex-col justify-center">
                <div>
                    <h2 class="text-2xl font-bold text-slate-900">Bem-vindo de volta!</h2>
                    <p class="text-slate-600 mt-1 text-sm">Insira seu e-mail e senha para aceder à sua conta.</p>
                </div>
                
                <form id="login-form" class="mt-8 space-y-5">
                    <div class="relative">
                        <label for="login-email" class="block text-xs font-semibold text-slate-600 mb-1">Email</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="seu.email@exemplo.com">
                         <i data-lucide="check-circle" id="email-check-icon" class="w-5 h-5 text-green-500 absolute right-3 top-1/2 mt-2 -translate-y-1/2 hidden"></i>
                    </div>
                    <div>
                        <label for="login-password" class="block text-xs font-semibold text-slate-600 mb-1">Senha</label>
                        <div class="relative">
                            <input type="password" id="login-password" required class="w-full px-4 py-2.5 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="••••••••">
                            <button type="button" id="password-toggle-btn" class="absolute inset-y-0 right-0 flex items-center px-3 text-slate-500 hover:text-slate-700">
                                <i data-lucide="eye" id="password-toggle-icon" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex justify-end pt-2">
                        <button type="submit" class="w-1/2 flex items-center justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors gap-2">
                            <span>Continuar</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Right Panel (Quote) -->
            <div class="hidden md:w-1/2 p-12 bg-slate-50/50 md:flex flex-col justify-center">
                <blockquote class="text-lg font-medium text-slate-700 leading-relaxed">
                    "A capacidade de prototipar rapidamente produtos prontos para o mercado em minutos realmente nos ajudou a expandir as nossas capacidades rapidamente."
                </blockquote>
                <div class="mt-6 flex items-center gap-4">
                    <img src="https://placehold.co/40x40/a3a3a3/ffffff?text=A" alt="Avatar de Alison Bothman" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-semibold text-slate-800 text-sm">Alison Bothman</p>
                        <p class="text-slate-500 text-xs">Designer de Produto, Google</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="hidden">
        <div class="relative h-screen md:flex overflow-hidden">
            <!-- Sidebar -->
            <aside id="sidebar" class="bg-white text-slate-700 w-64 p-4 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30 flex flex-col">
                <!-- Logotipo -->
                <div class="flex items-center gap-3 px-2 mb-8 flex-shrink-0">
                    <div class="bg-indigo-600 text-white w-9 h-9 flex items-center justify-center rounded-lg">
                        <i data-lucide="gem" class="w-5 h-5"></i>
                    </div>
                    <h1 class="text-xl font-bold text-slate-800">Somai</h1>
                </div>

                <!-- Menu de Navegação -->
                <nav class="flex-1 space-y-6 overflow-y-auto">
                    <!-- Grupo Principal -->
                    <div>
                        <span class="px-3 text-xs font-semibold uppercase text-slate-400">Principal</span>
                        <div class="mt-2 space-y-1">
                            <a href="#" class="nav-link business-link flex items-center gap-3 px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5 text-slate-500"></i><span>Painel</span></a>
                            <a href="#" class="nav-link business-link flex items-center gap-3 px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="deliveries"><i data-lucide="truck" class="w-5 h-5 text-slate-500"></i><span>Entregas</span></a>
                            <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="financials"><i data-lucide="dollar-sign" class="w-5 h-5 text-slate-500"></i><span>Financeiro</span></a>
                        </div>
                    </div>
                    <!-- Grupo Registos -->
                    <div>
                        <span class="px-3 text-xs font-semibold uppercase text-slate-400">Registos</span>
                        <div class="mt-2 space-y-1">
                             <a href="#" class="nav-link business-link flex items-center gap-3 px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="history"><i data-lucide="history" class="w-5 h-5 text-slate-500"></i><span>Histórico</span></a>
                            <a href="#" class="nav-link business-link flex items-center gap-3 px-3 py-2 text-sm text-slate-600 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="customers"><i data-lucide="users" class="w-5 h-5 text-slate-500"></i><span>Clientes</span></a>
                        </div>
                    </div>
                     <!-- Grupo Gestão -->
                    <div>
                        <span class="px-3 text-xs font-semibold uppercase text-slate-400">Gestão</span>
                        <div class="mt-2 space-y-1">
                            <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="products"><i data-lucide="package" class="w-5 h-5 text-slate-500"></i><span>Produtos</span></a>
                            <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="inventory"><i data-lucide="boxes" class="w-5 h-5 text-slate-500"></i><span>Estoque</span></a>
                            <a href="#" class="nav-link flex items-center gap-3 px-3 py-2 text-sm text-slate-700 hover:bg-slate-100 hover:text-slate-900 rounded-lg transition-colors" data-page="motoboys"><i data-lucide="bike" class="w-5 h-5 text-slate-500"></i><span>Motoboys</span></a>
                        </div>
                    </div>
                </nav>
                
                <!-- Menu Inferior -->
                <div class="mt-6 flex-shrink-0">
                    <div class="flex items-center justify-between px-2 py-3 mt-2">
                        <span id="view-mode-label" class="text-sm font-semibold text-slate-600">Empresa</span>
                        <label for="view-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="view-mode-toggle" class="sr-only toggle-view-checkbox">
                            <div class="toggle-view-label w-11 h-6 bg-slate-200 rounded-full transition-colors relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-transform dot"></div>
                        </label>
                    </div>

                    <button id="logout-btn" class="w-full flex items-center gap-3 px-3 py-2 text-sm text-red-500 hover:bg-red-50 hover:text-red-600 rounded-lg transition-colors mt-1">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                        <span>Sair</span>
                    </button>
                </div>
            </aside>
            <!-- Conteúdo Principal -->
            <main class="flex-1 h-screen overflow-y-auto relative bg-slate-50">
                <!-- Top Header -->
                <header class="sticky top-0 bg-slate-50/80 backdrop-blur-md z-20 border-b border-slate-200 flex items-center justify-between py-3 px-4 sm:px-6 lg:px-8">
                    <h2 id="header-title" class="text-xl font-bold text-slate-800">Painel</h2>
                    
                    <!-- Right side controls -->
                    <div class="flex items-center gap-3">
                        <div id="notification-bell-container" class="relative">
                            <button id="notification-bell-btn" class="p-2 rounded-full hover:bg-slate-200 transition-colors">
                                <i data-lucide="bell" class="bell-icon text-slate-600 w-5 h-5"></i>
                                <span id="notification-dot" class="absolute top-1.5 right-1.5 block h-2 w-2 rounded-full bg-red-500 hidden"></span>
                            </button>
                            <div id="notifications-dropdown" class="absolute right-0 mt-2 w-72 bg-white rounded-lg shadow-xl border border-slate-200 p-4 hidden">
                                <h3 class="font-semibold text-slate-800 mb-2 text-sm">Notificações</h3>
                                <div id="notifications-list" class="space-y-2"></div>
                            </div>
                        </div>
                         <div id="support-icon-container" class="relative">
                            <button id="support-icon-btn" class="p-2 rounded-full hover:bg-slate-200 transition-colors">
                                <i data-lucide="message-square" class="support-icon text-slate-600 w-5 h-5"></i>
                            </button>
                        </div>
                        <div class="w-px h-6 bg-slate-200"></div> <!-- Divider -->
                        <div id="user-profile" class="flex items-center gap-3 cursor-pointer">
                            <img id="user-avatar-img" src="" class="w-9 h-9 rounded-full bg-slate-200 object-cover hidden">
                            <div id="user-avatar-initials" class="w-9 h-9 rounded-full bg-indigo-500 text-white flex items-center justify-center font-bold text-base">
                                <span>?</span>
                            </div>
                            <div>
                                <span id="user-name" class="font-semibold text-slate-800 text-sm">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </header>

                 <!-- Page Content -->
                <div id="page-content-wrapper" class="p-4 sm:p-6 lg:p-8">
                    <div id="page-dashboard" class="page"></div>
                    <div id="page-deliveries" class="page hidden"></div>
                    <div id="page-history" class="page hidden"></div>
                    <div id="page-customers" class="page hidden"></div>
                    <div id="page-products" class="page hidden"></div>
                    <div id="page-inventory" class="page hidden"></div>
                    <div id="page-financials" class="page hidden"></div>
                    <div id="page-motoboys" class="page hidden"></div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modal de Criação de Pedido -->
    <div id="order-creation-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-slate-50 rounded-xl shadow-2xl flex flex-col transition-all duration-300 transform scale-95 opacity-0">
           <!-- O conteúdo será injetado aqui pelo JavaScript -->
        </div>
    </div>
    
    <!-- Avatar Selection Modal -->
    <div id="avatar-selection-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transition-all duration-300 transform scale-95 opacity-0">
            <div class="flex justify-between items-center mb-4">
                 <h3 class="text-lg font-bold text-slate-800">Escolha o seu Avatar</h3>
                 <button id="close-avatar-modal-btn" class="p-2 rounded-full hover:bg-slate-100 transition-colors">
                     <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
                 </button>
            </div>
            <div id="avatar-options-grid" class="grid grid-cols-4 gap-4">
                <!-- Avatar options will be rendered here by JS -->
            </div>
        </div>
    </div>

    <!-- Modal de Criação de Despesa -->
    <div id="expense-creation-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] transition-all duration-300 transform scale-95 opacity-0">
           <!-- O conteúdo será injetado aqui pelo JavaScript -->
        </div>
    </div>
    
    <!-- Modal de Criação de Renda Pessoal -->
    <div id="personal-income-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] transition-all duration-300 transform scale-95 opacity-0">
           <!-- O conteúdo será injetado aqui pelo JavaScript -->
        </div>
    </div>

    <!-- Modal de Atribuição de Motoboy -->
     <div id="assign-motoboy-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] transition-all duration-300 transform scale-95 opacity-0">
           <!-- O conteúdo será injetado aqui pelo JavaScript -->
        </div>
    </div>
    
    <!-- Modal de Importação com IA -->
    <div id="image-import-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col transition-all duration-300 transform scale-95 opacity-0">
           <!-- Conteúdo injetado pelo JavaScript -->
        </div>
    </div>
    
    <!-- Modal de Abertura/Fechamento de Caixa -->
    <div id="cash-session-modal" class="modal-container fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-40 opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm max-h-[90vh] transition-all duration-300 transform scale-95 opacity-0">
            <!-- Conteúdo injetado aqui -->
        </div>
    </div>

    <!-- Support Chat Popup -->
    <div id="support-chat-popup" class="fixed bottom-5 right-5 w-full max-w-sm h-auto bg-white rounded-2xl shadow-2xl border border-slate-200 flex flex-col transform scale-95 opacity-0 pointer-events-none z-30">
        <div class="flex items-center justify-between p-3 border-b border-slate-200 flex-shrink-0">
            <h3 class="font-semibold text-slate-800 text-base">Fale com a Somia</h3>
            <button id="close-chat-btn" class="p-1 rounded-full hover:bg-slate-100">
                <i data-lucide="x" class="w-5 h-5 text-slate-500"></i>
            </button>
        </div>
        <div id="chat-messages" class="flex-1 p-4 space-y-3 overflow-y-auto h-80">
            <!-- As mensagens do chat serão injetadas aqui -->
        </div>
        <div id="chat-typing-indicator" class="p-4 hidden">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-indigo-500 text-white flex items-center justify-center flex-shrink-0">
                    <i data-lucide="bot" class="w-5 h-5"></i>
                </div>
                <div class="typing-indicator flex items-center gap-1">
                    <span class="h-2 w-2 bg-slate-400 rounded-full"></span>
                    <span class="h-2 w-2 bg-slate-400 rounded-full"></span>
                    <span class="h-2 w-2 bg-slate-400 rounded-full"></span>
                </div>
            </div>
        </div>
        <div class="p-3 border-t border-slate-200 flex-shrink-0">
            <form id="chat-form" class="flex items-center gap-2">
                <input type="text" id="chat-input" placeholder="Pergunte algo..." class="w-full p-2.5 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm" autocomplete="off">
                <button type="submit" class="bg-indigo-600 text-white p-2.5 rounded-lg hover:bg-indigo-700 transition-colors">
                    <i data-lucide="send-horizontal" class="w-5 h-5"></i>
                </button>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ---------- CONFIGURAÇÃO DO SUPABASE ----------
        const SUPABASE_URL = 'https://fhyjboeccjkoyugghyfy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZoeWpib2VjY2prb3l1Z2doeWZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjczNDIsImV4cCI6MjA2NjM0MzM0Mn0.paBp2MolOSy1z5Pi46tykZ2wqjH7oHfBT2bU4BEN9yE';
        const { createClient } = window.supabase;
        const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ---------- ELEMENTOS DA UI ----------
        const loadingOverlay = document.getElementById('loading-overlay');
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const passwordToggleBtn = document.getElementById('password-toggle-btn');
        const emailInput = document.getElementById('login-email');
        const emailCheckIcon = document.getElementById('email-check-icon');
        const notificationBellBtn = document.getElementById('notification-bell-btn');
        const notificationDot = document.getElementById('notification-dot');
        const notificationsDropdown = document.getElementById('notifications-dropdown');
        const notificationsList = document.getElementById('notifications-list');
        const viewModeToggle = document.getElementById('view-mode-toggle');
        const viewModeLabel = document.getElementById('view-mode-label');
        const supportIconBtn = document.getElementById('support-icon-btn');
        const supportChatPopup = document.getElementById('support-chat-popup');
        const closeChatBtn = document.getElementById('close-chat-btn');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const typingIndicator = document.getElementById('chat-typing-indicator');

        // ---------- Namespace e Estado do App ----------
        const App = { 
            state: {
                isInitialized: false,
                viewMode: 'empresa',
                notifications: [],
                hasUnreadNotifications: false,
                customers: [], products: [], orders: [], expenses: [], personalIncomes: [], motoboys: [],
                ingredients: [], productIngredients: [], orderItems: [],
                cashSessions: [],
                activeCashSession: null,
                editingOrderId: null,
                currentOrder: {},
                importedImageData: null,
                currentImportType: null,
                scannedProducts: [],
                currentUser: null,
                isChatOpen: false,
                chatHistory: [],
                productFormImageFile: null,
                sessionOrdersCurrentPage: 1,
            }, 
            editingId: { customer: null, product: null, ingredient: null, motoboy: null },
            confirmAction: null,
        };
        
        App.resetCurrentOrder = () => {
            App.state.editingOrderId = null;
            App.state.currentOrder = {
                customer_id: null,
                items: [],
                total: 0,
                payment_method: 'Dinheiro',
                status: 'Pendente',
                is_delivery: false,
                notes: '',
                delivery_cost: 0,
                step: 1,
                is_internal_consumption: false
            };
        };
        App.resetCurrentOrder();

        // ---------- FUNÇÕES DE UTILIDADE ----------
        App.showLoading = () => { if(loadingOverlay) loadingOverlay.classList.remove('hidden'); };
        App.hideLoading = () => { if(loadingOverlay) setTimeout(() => loadingOverlay.classList.add('hidden'), 200); };
        App.formatCurrency = (value) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
        App.formatDateTime = (dateString) => {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('pt-BR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit',
                timeZone: 'UTC'
            });
        };
        App.formatDate = (dateString) => new Date(dateString).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' });
        
        App.getNumericValue = (value) => {
            if (typeof value === 'number') return value;
            if (!value || typeof value !== 'string') return 0;
            const numericString = value.replace('R$', '').replace(/\./g, '').replace(',', '.').trim();
            const number = parseFloat(numericString);
            return isNaN(number) ? 0 : number;
        };

        App.maskCurrency = (event) => {
            const input = event.target;
            let value = input.value.replace(/\D/g, '');

            if (!value) {
                input.value = "";
                return;
            }
            
            const numericValue = parseInt(value, 10) / 100;
            input.value = App.formatCurrency(numericValue);
        };

        App.showToast = (message, isError = false) => {
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.querySelector('p').textContent = message;
            toast.className = 'toast fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl z-50';
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-600');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        };
        
        App.playCashRegisterSound = () => {
            if (typeof Tone === 'undefined' || !Tone) return;

            const bell = new Tone.MetalSynth({
                frequency: 400,
                envelope: { attack: 0.001, decay: 0.14, release: 0.2 },
                harmonicity: 5.1,
                modulationIndex: 32,
                resonance: 4000,
                octaves: 1.5
            }).toDestination();
            bell.volume.value = -12;

            const drawer = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: { attack: 0.005, decay: 0.2, sustain: 0, release: 0.1 },
            }).toDestination();
            drawer.volume.value = -25;
            
            const now = Tone.now();
            if (Tone.context.state !== 'running') { Tone.start(); }
            bell.triggerAttack(now);
            drawer.triggerAttack(now + 0.08);
        };
        
        App.showSaleNotification = (value) => {
            const notification = document.getElementById('sale-notification');
            const saleValueEl = document.getElementById('sale-value');
            if (!notification || !saleValueEl) return;
            
            saleValueEl.textContent = `+ ${App.formatCurrency(value)}`;
            App.playCashRegisterSound();

            notification.classList.add('show');
            setTimeout(() => {
                 notification.classList.remove('show');
            }, 3000);
        };
        
        // ---------- LÓGICA DE AUTENTICAÇÃO ----------
        App.updateUserInfo = (user) => {
            const userNameEl = document.getElementById('user-name');
            const userAvatarImgEl = document.getElementById('user-avatar-img');
            const userAvatarInitialsEl = document.getElementById('user-avatar-initials');

            if (!user || !userNameEl || !userAvatarImgEl || !userAvatarInitialsEl) return;

            const metadata = user.user_metadata;
            let displayName = 'Utilizador';

            if(metadata && metadata.full_name) {
                displayName = metadata.full_name;
            } else if (user.email) {
                displayName = user.email.split('@')[0];
                displayName = displayName.replace(/[._-]/g, ' ');
                displayName = displayName.split(' ').map(name => name.charAt(0).toUpperCase() + name.slice(1)).join(' ');
            }
            
            const avatarFile = metadata?.avatar_url;

            userNameEl.textContent = displayName;
            
            if (avatarFile) {
                const { data } = db.storage.from('icones').getPublicUrl(`avatares/${avatarFile}`);
                if (data.publicUrl) {
                    userAvatarImgEl.src = data.publicUrl;
                    userAvatarImgEl.classList.remove('hidden');
                    userAvatarInitialsEl.classList.add('hidden');
                } else {
                     userAvatarImgEl.classList.add('hidden');
                     userAvatarInitialsEl.classList.remove('hidden');
                }
            } else {
                 userAvatarImgEl.classList.add('hidden');
                 userAvatarInitialsEl.classList.remove('hidden');
                 const initial = displayName.charAt(0).toUpperCase();
                 userAvatarInitialsEl.querySelector('span').textContent = initial;
            }
        };

        if (loginForm) {
            loginForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                App.showLoading(); 
                const email = document.getElementById('login-email').value; 
                const password = document.getElementById('login-password').value; 
                const { error } = await db.auth.signInWithPassword({ email, password }); 
                if (error) { App.showToast('Email ou senha inválidos.', true); } 
                App.hideLoading(); 
            });
        }
        if (logoutBtn) { logoutBtn.addEventListener('click', async () => { App.showLoading(); await db.auth.signOut(); App.hideLoading(); }); }
        if (passwordToggleBtn) {
            passwordToggleBtn.addEventListener('click', () => {
                const passwordInput = document.getElementById('login-password');
                const icon = document.getElementById('password-toggle-icon');
                const isPassword = passwordInput.type === 'password';
                passwordInput.type = isPassword ? 'text' : 'password';
                icon.setAttribute('data-lucide', isPassword ? 'eye-off' : 'eye');
                lucide.createIcons();
            });
        }
        if(emailInput) {
            emailInput.addEventListener('input', () => {
                const emailRegex = /^\S+@\S+\.\S+$/;
                if(emailRegex.test(emailInput.value)){
                    emailCheckIcon.classList.remove('hidden');
                } else {
                    emailCheckIcon.classList.add('hidden');
                }
            });
        }
        
        db.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                if (!App.state.isInitialized) {
                    App.state.isInitialized = true;
                    App.state.currentUser = session.user;
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    await App.init();
                } else if (event === 'USER_UPDATED') {
                    App.state.currentUser = session.user;
                    App.updateUserInfo(session.user);
                }
            } else {
                App.state.isInitialized = false;
                App.state.currentUser = null;
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                App.hideLoading();
            }
        });

        // ---------- LÓGICA PRINCIPAL DA APLICAÇÃO ----------
        App.loadData = async () => {
            App.showLoading();
            try {
                const results = await Promise.all([
                    db.from('customers').select('*').order('name'),
                    db.from('products').select('*').order('name'),
                    db.from('orders').select('*, customers(*)').order('created_at', { ascending: false }),
                    db.from('expenses').select('*').order('date', { ascending: false }),
                    db.from('personal_incomes').select('*').order('date', { ascending: false }),
                    db.from('ingredients').select('*').order('name'),
                    db.from('product_ingredients').select('*, ingredients(name, unit)'),
                    db.from('order_items').select('*, products(id, name, category)'),
                    db.from('motoboys').select('*').order('name'),
                    db.from('caixa_sessoes').select('*').order('data_abertura', { ascending: false })
                ]);
                results.forEach(res => { if (res.error) throw res.error; });
                [App.state.customers, App.state.products, App.state.orders, App.state.expenses, App.state.personalIncomes, App.state.ingredients, App.state.productIngredients, App.state.orderItems, App.state.motoboys, App.state.cashSessions] = results.map(res => res.data || []);

                App.state.activeCashSession = App.state.cashSessions.find(s => s.data_fechamento === null);

            } catch (error) { console.error("Erro ao carregar dados:", error); App.showToast(`Erro ao carregar dados: ${error.message}.`, true); } 
            finally { App.hideLoading(); }
        };
        
        App.updateViewMode = () => {
            const isPersonalMode = App.state.viewMode === 'pessoal';
            
            viewModeLabel.textContent = isPersonalMode ? 'Pessoal' : 'Empresa';
            document.querySelectorAll('.business-link').forEach(link => { link.style.display = isPersonalMode ? 'none' : 'flex'; });
            
            const currentPageLink = document.querySelector('.nav-link.active-link');
            const currentPageId = currentPageLink ? currentPageLink.dataset.page : 'dashboard';

             if (isPersonalMode) {
                if (!['financials'].includes(currentPageId)) App.navigateTo('financials');
                else App.renderActivePage(currentPageId);
            } else {
                if (currentPageId === 'financials') App.navigateTo('dashboard');
                else App.renderActivePage(currentPageId);
            }
        };

        App.navigateTo = (pageId) => {
            App.closeAllModals();
            App.state.sessionOrdersCurrentPage = 1;

            const pages = document.querySelectorAll('.page');
            pages.forEach(p => p.classList.add('hidden'));
            const page = document.getElementById(`page-${pageId}`);
            if (page) {
                page.classList.remove('hidden');
                page.innerHTML = '<div class="flex justify-center items-center h-full pt-16"><div class="loader"></div></div>'; 
                App.renderActivePage(pageId);
            }

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active-link'));
            
            const activeLink = document.querySelector(`.nav-link[data-page='${pageId}']`);
            if (activeLink) {
                activeLink.classList.add('active-link');
                const headerTitleEl = document.getElementById('header-title');
                if (headerTitleEl) {
                    const spanElement = activeLink.querySelector('span');
                    if (spanElement) {
                        headerTitleEl.textContent = spanElement.textContent;
                    }
                }
            }
            
            App.processNotifications();
        };
        
        App.renderActivePage = (pageId) => {
             const isPersonalMode = App.state.viewMode === 'pessoal';
             if (isPersonalMode && !['financials', 'products', 'inventory'].includes(pageId)) {
                 App.navigateTo('financials');
                 return;
             }
             
             switch(pageId) {
                case 'dashboard': App.renderDashboard(); break;
                case 'deliveries': App.renderDeliveries(); break;
                case 'history': App.renderHistory(); break;
                case 'customers': App.renderCustomers(); break;
                case 'products': App.renderProducts(); break;
                case 'inventory': App.renderInventory(); break;
                case 'financials': App.renderFinancials(); break;
                case 'motoboys': App.renderMotoboysPage(); break;
                default: break;
            }
            lucide.createIcons();
        };

        // --- LÓGICA DE NOTIFICAÇÕES ---
        App.processNotifications = () => {
            App.state.notifications = [];
            const lowStockItems = App.state.ingredients.filter(i => i.stock_quantity < i.min_stock_quantity);
            
            if (lowStockItems.length > 0) {
                App.state.hasUnreadNotifications = true;
                lowStockItems.forEach(item => {
                    App.state.notifications.push({
                        id: `stock-${item.id}`,
                        message: `${item.name} está com o estoque baixo.`
                    });
                });
            } else {
                App.state.hasUnreadNotifications = false;
            }

            App.renderNotificationBell();
        };

        App.renderNotificationBell = () => {
            const bellContainer = document.getElementById('notification-bell-container');
            if (App.state.hasUnreadNotifications) {
                notificationDot.classList.remove('hidden');
                bellContainer.classList.add('has-notification');
            } else {
                notificationDot.classList.add('hidden');
                bellContainer.classList.remove('has-notification');
            }
        };

        App.toggleNotifications = () => {
            const isHidden = notificationsDropdown.classList.toggle('hidden');
            if (!isHidden) { 
                App.state.hasUnreadNotifications = false;
                App.renderNotificationBell();
                App.renderNotificationsList();
            }
        };

        App.renderNotificationsList = () => {
            notificationsList.innerHTML = '';
            if (App.state.notifications.length === 0) {
                notificationsList.innerHTML = `<p class="text-slate-500 text-xs text-center">Tudo em dia!</p>`;
                return;
            }

            App.state.notifications.forEach(notif => {
                const notifElement = document.createElement('div');
                notifElement.className = 'p-2 border-b border-slate-100 text-xs text-slate-700 flex items-start gap-2';
                notifElement.innerHTML = `
                    <i data-lucide="alert-circle" class="w-4 h-4 text-amber-500 mt-0.5"></i>
                    <span>${notif.message}</span>
                `;
                notificationsList.appendChild(notifElement);
            });
            lucide.createIcons();
        };

        // --- RENDERIZAÇÃO DAS PÁGINAS ---
        App.renderDashboard = () => {
            const page = document.getElementById('page-dashboard');
            const { activeCashSession } = App.state;

            if (activeCashSession) {
                const ordersInSession = App.state.orders.filter(o => o.caixa_sessao_id === activeCashSession.id && o.status !== 'Cancelado');
                const totalDinheiro = ordersInSession.filter(o => o.payment_method === 'Dinheiro').reduce((sum, o) => sum + o.total_value, 0);
                const totalCartao = ordersInSession.filter(o => o.payment_method === 'Cartão').reduce((sum, o) => sum + o.total_value, 0);
                const totalPix = ordersInSession.filter(o => o.payment_method === 'Pix').reduce((sum, o) => sum + o.total_value, 0);
                const valorEsperado = activeCashSession.valor_abertura + totalDinheiro;
                const itemsInSession = App.state.orderItems.filter(item => ordersInSession.some(o => o.id === item.order_id));
                const marmitasVendidas = itemsInSession.reduce((sum, item) => { const product = App.state.products.find(p => p.id === item.product_id); return (product && product.category === 'principal') ? sum + item.quantity : sum; }, 0);

                page.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <div>
                                <p class="text-sm text-slate-500">Caixa aberto em: ${App.formatDateTime(activeCashSession.data_abertura)}</p>
                            </div>
                            <div class="flex gap-2">
                                <button id="lancar-pedido-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 text-sm"><i data-lucide="plus" class="w-4 h-4"></i>Lançar Pedido</button>
                                <button id="close-caixa-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2 text-sm"><i data-lucide="lock" class="w-4 h-4"></i>Fechar Caixa</button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-xl shadow-sm"><h3 class="text-xs font-medium text-slate-500">Abertura do Caixa</h3><p class="text-xl font-bold text-slate-800 mt-1">${App.formatCurrency(activeCashSession.valor_abertura)}</p></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm"><h3 class="text-xs font-medium text-slate-500">Vendas em Dinheiro</h3><p class="text-xl font-bold text-slate-800 mt-1">${App.formatCurrency(totalDinheiro)}</p></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm"><h3 class="text-xs font-medium text-slate-500">Vendas (Pix/Cartão)</h3><p class="text-xl font-bold text-slate-800 mt-1">${App.formatCurrency(totalCartao + totalPix)}</p></div>
                            <div class="bg-green-100 p-4 rounded-xl shadow-sm border-l-4 border-green-500"><h3 class="text-xs font-medium text-green-800">Esperado em Caixa</h3><p class="text-xl font-bold text-green-900 mt-1">${App.formatCurrency(valorEsperado)}</p></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm col-span-1 md:col-span-2"><h3 class="text-xs font-medium text-slate-500">Pedidos na Sessão</h3><p class="text-xl font-bold text-slate-800 mt-1">${ordersInSession.length}</p></div>
                            <div class="bg-white p-4 rounded-xl shadow-sm col-span-1 md:col-span-2"><h3 class="text-xs font-medium text-slate-500">Marmitas Vendidas</h3><p class="text-xl font-bold text-slate-800 mt-1">${marmitasVendidas}</p></div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm flex flex-col">
                                <h3 class="text-base font-semibold text-slate-900 mb-4 flex-shrink-0">Pedidos da Sessão Atual</h3>
                                <div id="session-orders-list-container" class="flex-1 overflow-y-auto"></div>
                            </div>
                            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm flex flex-col">
                                <h3 class="text-base font-semibold text-slate-900 mb-4 flex-shrink-0">Acerto com Motoboys (Pendentes)</h3>
                                <div id="motoboy-payments-container" class="flex-1 overflow-y-auto"></div>
                            </div>
                        </div>

                    </div>
                `;
                App.renderSessionOrdersListContainer(ordersInSession);
                App.renderMotoboyPaymentsContainer();

            } else {
                page.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-sm text-center">
                        <i data-lucide="archive" class="w-16 h-16 text-slate-300 mx-auto mb-4"></i>
                        <h3 class="text-lg font-bold text-slate-800">O caixa está fechado.</h3>
                        <p class="text-sm text-slate-500 mt-2 mb-6">Clique no botão abaixo para iniciar uma nova sessão de vendas.</p>
                        <button id="open-caixa-btn" class="bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 mx-auto text-sm"><i data-lucide="unlock" class="w-4 h-4"></i>Abrir Caixa</button>
                    </div>

                    <div class="mt-8 bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-base font-semibold text-slate-900 mb-4">Histórico de Sessões de Caixa</h3>
                        <div id="cash-sessions-history-list" class="overflow-x-auto"></div>
                    </div>
                `;
                App.renderCashSessionsHistory();
            }
        };

        App.renderSessionOrdersListContainer = (orders) => {
            const container = document.getElementById('session-orders-list-container');
            if (!container) return;

            const ITEMS_PER_PAGE = 10;
            const currentPage = App.state.sessionOrdersCurrentPage || 1;
            const totalPages = Math.ceil(orders.length / ITEMS_PER_PAGE);
            const paginatedOrders = orders.slice((currentPage - 1) * ITEMS_PER_PAGE, currentPage * ITEMS_PER_PAGE);

            const tableHTML = `
                <table class="w-full text-left min-w-[400px] text-sm">
                    <thead class="border-b border-slate-200"><tr class="text-xs text-slate-500">
                        <th class="p-2 font-semibold">Cliente</th>
                        <th class="p-2 font-semibold">Hora</th>
                        <th class="p-2 font-semibold">Pagamento</th>
                        <th class="p-2 font-semibold text-right">Valor</th>
                    </tr></thead>
                    <tbody>
                        ${paginatedOrders.length === 0 ? `<tr><td colspan="4" class="text-center p-6 text-slate-500 text-sm">Nenhum pedido nesta sessão ainda.</td></tr>` : paginatedOrders.map(o => `
                            <tr class="border-b border-slate-100">
                                <td class="p-2">${o.customers?.name || 'N/A'}</td>
                                <td class="p-2">${new Date(o.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</td>
                                <td class="p-2">${o.payment_method}</td>
                                <td class="p-2 text-right font-medium">${App.formatCurrency(o.total_value)}</td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            `;

            let paginationHTML = '';
            if (totalPages > 1) {
                paginationHTML = `
                    <div class="flex justify-between items-center mt-4 text-xs pt-4 border-t border-slate-200">
                        <button data-list="session-orders" data-action="prev" ${currentPage === 1 ? 'disabled' : ''} class="pagination-btn p-1.5 rounded-md hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-left" class="w-4 h-4 pointer-events-none"></i></button>
                        <span class="font-semibold text-slate-600">Página ${currentPage} de ${totalPages}</span>
                        <button data-list="session-orders" data-action="next" ${currentPage === totalPages ? 'disabled' : ''} class="pagination-btn p-1.5 rounded-md hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="arrow-right" class="w-4 h-4 pointer-events-none"></i></button>
                    </div>
                `;
            }

            container.innerHTML = tableHTML + paginationHTML;
            lucide.createIcons();
        };

        App.renderMotoboyPaymentsContainer = () => {
            const container = document.getElementById('motoboy-payments-container');
            if(!container) return;
            const unpaidDeliveries = App.state.orders.filter(o => o.is_delivery && o.delivery_cost > 0 && !o.delivery_fee_paid && o.motoboy_id);
            
            const paymentsByMotoboy = App.state.motoboys.map(motoboy => {
                const deliveries = unpaidDeliveries.filter(d => d.motoboy_id === motoboy.id);
                const totalToPay = deliveries.reduce((sum, d) => sum + d.delivery_cost, 0);
                return { ...motoboy, totalToPay, deliveryIds: deliveries.map(d => d.id) };
            }).filter(m => m.totalToPay > 0);

            if (paymentsByMotoboy.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhum pagamento pendente.</p>`;
                return;
            }
            container.innerHTML = `<ul class="divide-y divide-slate-200">${paymentsByMotoboy.map(m => `<li class="py-3 flex justify-between items-center"><div><p class="font-semibold text-slate-800 text-sm">${m.name}</p><p class="text-xs text-slate-500">${m.deliveryIds.length} entregas</p></div><div class="flex items-center gap-3"><span class="font-semibold text-base text-green-600">${App.formatCurrency(m.totalToPay)}</span><button data-id="${m.id}" data-amount="${m.totalToPay}" data-delivery-ids='${JSON.stringify(m.deliveryIds)}' class="pay-motoboy-btn bg-green-100 text-green-700 font-semibold px-3 py-1.5 rounded-lg hover:bg-green-200 transition-colors text-xs">Pagar</button></div></li>`).join('')}</ul>`;
        };

        App.renderCashSessionsHistory = () => {
            const container = document.getElementById('cash-sessions-history-list');
            if (!container) return;
            const closedSessions = App.state.cashSessions.filter(s => s.data_fechamento);
             if (closedSessions.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center py-6 text-sm">Nenhuma sessão de caixa anterior encontrada.</p>`;
                return;
            }
            container.innerHTML = `
                <table class="w-full text-left min-w-[600px] text-sm">
                    <thead class="border-b border-slate-200"><tr class="text-xs text-slate-500">
                        <th class="p-2 font-semibold">Abertura</th>
                        <th class="p-2 font-semibold">Fechamento</th>
                        <th class="p-2 font-semibold text-right">Valor Abertura</th>
                        <th class="p-2 font-semibold text-right">Valor Fechamento</th>
                        <th class="p-2 font-semibold text-right">Diferença</th>
                    </tr></thead>
                    <tbody>
                        ${closedSessions.map(s => {
                            const diff = s.valor_fechamento - (s.valor_abertura + (s.valor_apurado_dinheiro || 0));
                            const diffColor = diff === 0 ? 'text-slate-500' : (diff > 0 ? 'text-green-600' : 'text-red-600');
                            return `
                                <tr class="border-b border-slate-100">
                                    <td class="p-2">${App.formatDateTime(s.data_abertura)}</td>
                                    <td class="p-2">${App.formatDateTime(s.data_fechamento)}</td>
                                    <td class="p-2 text-right">${App.formatCurrency(s.valor_abertura)}</td>
                                    <td class="p-2 text-right">${App.formatCurrency(s.valor_fechamento)}</td>
                                    <td class="p-2 text-right font-bold ${diffColor}">${App.formatCurrency(diff)}</td>
                                </tr>
                            `}).join('')}
                    </tbody>
                </table>`;
        };
        
        App.renderCustomers = () => {
            const page = document.getElementById('page-customers');
            page.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <form id="customer-form" class="bg-white p-6 rounded-xl shadow-sm space-y-4">
                        <h3 id="customer-form-title" class="text-base font-semibold">Novo Cliente</h3>
                        <input type="hidden" id="customer-id">
                        <div>
                            <label for="customer-name" class="block text-xs font-medium text-slate-600">Nome</label>
                            <input type="text" id="customer-name" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label for="customer-phone" class="block text-xs font-medium text-slate-600">Contato (Telefone)</label>
                            <input type="tel" id="customer-phone" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label for="customer-address" class="block text-xs font-medium text-slate-600">Endereço</label>
                            <input type="text" id="customer-address" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="customer-number" class="block text-xs font-medium text-slate-600">Número</label>
                                <input type="text" id="customer-number" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label for="customer-neighborhood" class="block text-xs font-medium text-slate-600">Bairro</label>
                                <input type="text" id="customer-neighborhood" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="customer-complement" class="block text-xs font-medium text-slate-600">Complemento</label>
                            <input type="text" id="customer-complement" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div class="flex space-x-3 pt-2">
                            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors hover:bg-indigo-700 text-sm">Salvar</button>
                            <button type="button" id="cancel-edit-customer-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hidden hover:bg-slate-300 transition-colors text-sm">Cancelar</button>
                        </div>
                    </form>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="text-base font-semibold mb-4">Clientes Registados</h3>
                    <div id="customers-list-container" class="overflow-y-auto max-h-[500px]"></div>
                </div>
            </div>`;
            App.renderCustomersList();
        };

        App.formatAddress = (customer) => {
            if (!customer) return 'Sem endereço';
            const parts = [
                customer.address,
                customer.numero,
                customer.bairro,
                customer.complemento
            ].filter(Boolean); // Filtra partes vazias ou nulas
            return parts.length > 0 ? parts.join(', ') : 'Sem endereço';
        };

        App.renderCustomersList = () => {
            const container = document.getElementById('customers-list-container');
            if(!container) return;
            if (App.state.customers.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhum cliente registado.</p>`; return; }
            container.innerHTML = `<ul class="divide-y divide-slate-100">${App.state.customers.map(c => `<li class="py-2.5 flex justify-between items-center hover:bg-slate-50 px-2 rounded-md"><div><p class="font-semibold text-slate-800 text-sm">${c.name}</p><p class="text-xs text-slate-500">${c.phone || 'Sem contato'}</p><p class="text-xs text-slate-500">${App.formatAddress(c)}</p></div><div class="flex items-center space-x-1"><button data-id="${c.id}" class="edit-customer-btn p-1.5 text-slate-500 hover:text-indigo-600 rounded-md transition-colors" title="Editar"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button><button data-id="${c.id}" class="delete-customer-btn p-1.5 text-slate-500 hover:text-red-600 rounded-md transition-colors" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div></li>`).join('')}</ul>`;
            lucide.createIcons();
        };
        
        App.renderProducts = () => {
            const page = document.getElementById('page-products');
            page.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <form id="product-form" class="bg-white p-6 rounded-xl shadow-sm space-y-4">
                            <h3 id="product-form-title" class="text-base font-semibold">Novo Produto</h3>
                            <input type="hidden" id="product-id">
                            <div>
                                <label class="block text-xs font-medium text-slate-600 mb-2">Imagem do Produto</label>
                                <div id="product-image-preview-container" class="w-full aspect-video bg-slate-100 rounded-lg flex items-center justify-center mb-2">
                                    <img id="product-image-preview" src="" class="hidden w-full h-full object-cover rounded-lg">
                                    <i data-lucide="image" id="product-image-placeholder" class="w-12 h-12 text-slate-400"></i>
                                    <div id="product-image-loader" class="loader hidden"></div>
                                </div>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <input type="file" id="product-image-upload" class="hidden" accept="image/*">
                                    <label for="product-image-upload" class="bg-slate-200 text-slate-700 font-semibold py-2 rounded-lg text-center cursor-pointer hover:bg-slate-300 transition">Carregar</label>
                                    <button type="button" id="generate-ai-image-btn" class="bg-blue-100 text-blue-700 font-semibold py-2 rounded-lg hover:bg-blue-200 transition">Gerar com IA</button>
                                </div>
                            </div>
                            <div><label for="product-name" class="block text-xs font-medium text-slate-600">Nome</label><input type="text" id="product-name" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div>
                            <div><label for="product-category" class="block text-xs font-medium text-slate-600">Categoria</label><select id="product-category" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg bg-white text-sm"><option value="principal">Principal</option><option value="extra">Extra</option></select></div>
                            <div><label for="product-price" class="block text-xs font-medium text-slate-600">Preço</label><input type="text" id="product-price" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm" inputmode="decimal"></div>
                            <div class="flex space-x-3 pt-2"><button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-sm">Salvar</button><button type="button" id="cancel-edit-product-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hidden hover:bg-slate-300 transition-colors text-sm">Cancelar</button></div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-base font-semibold mb-4">Produtos Registados</h3>
                        <div id="products-list-container" class="space-y-6"></div>
                    </div>
                </div>`;
            App.renderProductsList();
            document.getElementById('product-price').addEventListener('input', App.maskCurrency);
            lucide.createIcons();
        };

        App.renderProductsList = () => {
            const container = document.getElementById('products-list-container');
            if(!container) return;

            const activeProducts = App.state.products.filter(p => p.is_active !== false); // Treat null as true
            const inactiveProducts = App.state.products.filter(p => p.is_active === false);

            const renderTable = (title, products, isActiveTable) => {
                if (products.length === 0 && title === "Inativos") return '';
                 if (products.length === 0 && title === "Ativos") {
                     return `<div><h3 class="text-base font-semibold mb-4 text-slate-800">${title}</h3><p class="text-slate-500 text-center py-8 text-sm">Nenhum produto ativo.</p></div>`
                 }

                return `
                    <div>
                        <h3 class="text-base font-semibold mb-4 text-slate-800">${title}</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[400px] text-sm">
                                <thead class="border-b border-slate-200"><tr class="text-xs text-slate-500"><th class="p-2 font-semibold">Produto</th><th class="p-2 font-semibold">Preço</th><th class="p-2 font-semibold text-right">Ações</th></tr></thead>
                                <tbody>
                                    ${products.map(p => `
                                        <tr class="border-b border-slate-100 hover:bg-slate-50 ${!isActiveTable ? 'opacity-60 bg-slate-50' : ''}">
                                            <td class="p-3 font-medium flex items-center gap-3">
                                                <img src="${p.image_url || 'https://placehold.co/40x40/e2e8f0/475569?text=??'}" alt="${p.name}" class="w-10 h-10 rounded-md object-cover bg-slate-100">
                                                <span>${p.name}</span>
                                            </td>
                                            <td class="p-3">${App.formatCurrency(p.price)}</td>
                                            <td class="p-3 text-right">
                                                <div class="flex items-center justify-end space-x-1">
                                                    <button data-id="${p.id}" class="edit-product-btn p-1.5 text-slate-500 hover:text-indigo-600 rounded-md transition-colors" title="Editar"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                                                    ${isActiveTable 
                                                        ? `<button data-id="${p.id}" class="deactivate-product-btn p-1.5 text-slate-500 hover:text-red-600 rounded-md transition-colors" title="Desativar"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>`
                                                        : `<button data-id="${p.id}" class="activate-product-btn p-1.5 text-slate-500 hover:text-green-600 rounded-md transition-colors" title="Reativar"><i data-lucide="check-circle" class="w-4 h-4 pointer-events-none"></i></button>`
                                                    }
                                                </div>
                                            </td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            };
            
            container.innerHTML = renderTable('Ativos', activeProducts, true) + renderTable('Inativos', inactiveProducts, false);
            lucide.createIcons();
        };
        App.renderDeliveries = () => { 
            const page = document.getElementById('page-deliveries');
            const pendingOrders = App.state.orders.filter(o => o.status === 'Pendente');
            page.innerHTML = `<div id="deliveries-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${pendingOrders.length === 0 ? '<p class="text-slate-500 col-span-full text-center py-8 text-sm">Nenhuma entrega ou retirada pendente.</p>' : pendingOrders.map(order => { const items = App.state.orderItems.filter(item => item.order_id === order.id); const notesHTML = order.notes ? `<div class="border-t border-slate-100 mt-3 pt-3"><p class="text-xs text-slate-600"><strong class="font-semibold text-slate-700">Obs:</strong> ${order.notes}</p></div>` : ''; return `<div class="bg-white p-4 rounded-xl shadow-sm space-y-3 flex flex-col"><div><p class="font-bold text-base text-slate-800">${order.customers?.name || 'N/A'}</p><p class="text-xs text-slate-500">${App.formatAddress(order.customers)}</p></div><div class="flex items-center justify-between"><span class="text-xs font-bold py-1 px-2 rounded-full ${order.is_delivery ? 'bg-indigo-100 text-indigo-800' : 'bg-orange-100 text-orange-800'}">${order.is_delivery ? 'ENTREGA' : 'RETIRADA'}</span> <span class="font-bold text-lg text-slate-800">${App.formatCurrency(order.total_value)}</span></div><div class="flex-1"><p class="text-xs font-semibold text-slate-600">Itens:</p><ul class="text-xs list-disc list-inside text-slate-500 pl-2">${items.map(i => `<li>${i.quantity}x ${i.products?.name || 'Produto'}</li>`).join('')}</ul></div>${notesHTML}<div class="border-t border-slate-200 pt-3 flex justify-end gap-2 items-center"><button data-id="${order.id}" class="edit-order-btn p-1.5 text-slate-500 hover:bg-slate-200 rounded-lg transition-colors" title="Editar Pedido"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button><div class="flex-grow"></div><button data-id="${order.id}" class="cancel-order-btn bg-red-100 text-red-700 px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-red-200 transition-colors">Cancelar</button><button data-id="${order.id}" class="mark-delivered-btn bg-green-100 text-green-700 px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-green-200 transition-colors">Finalizar</button></div></div>`}).join('')}</div>`;
        };
        App.renderHistory = () => {
            const page = document.getElementById('page-history');
            page.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-sm"><div id="history-list" class="overflow-x-auto"></div></div>`;
            const container = document.getElementById('history-list');
            if (App.state.orders.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhum pedido no histórico.</p>`;
                return;
            }

            container.innerHTML = `
                <table class="w-full text-left min-w-[800px] text-sm">
                    <thead class="border-b border-slate-200">
                        <tr class="text-xs text-slate-500 uppercase">
                            <th class="p-3 font-semibold">Cliente</th>
                            <th class="p-3 font-semibold">Tipo</th>
                            <th class="p-3 font-semibold">Data</th>
                            <th class="p-3 font-semibold">Valor</th>
                            <th class="p-3 font-semibold">Observações</th>
                            <th class="p-3 font-semibold">Status</th>
                            <th class="p-3 font-semibold text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${App.state.orders.map(order => {
                            let typeInfo = '';
                            if (order.is_internal_consumption) {
                                typeInfo = `<span class="flex items-center gap-2 text-indigo-700 font-medium"><i data-lucide="coffee" class="w-4 h-4"></i>Consumo Interno</span>`;
                            } else if (order.is_delivery) {
                                typeInfo = `<span class="flex items-center gap-2"><i data-lucide="truck" class="w-4 h-4 text-slate-500"></i>Entrega</span>`;
                            } else {
                                typeInfo = `<span class="flex items-center gap-2"><i data-lucide="shopping-bag" class="w-4 h-4 text-slate-500"></i>Retirada</span>`;
                            }
                            const statusBadge = App.getOrderStatusBadgeHTML(order);
                            const actionButton = App.getOrderActionsHTML(order);
                            const notesText = order.notes || '—';

                            return `<tr class="border-b border-slate-100 hover:bg-slate-50" data-order-id="${order.id}">
                                        <td class="p-3">${order.is_internal_consumption ? 'N/A' : (order.customers?.name || 'Cliente Removido')}</td>
                                        <td class="p-3">${typeInfo}</td>
                                        <td class="p-3">${App.formatDate(order.created_at)}</td>
                                        <td class="p-3 font-medium">${App.formatCurrency(order.total_value)}</td>
                                        <td class="p-3 text-slate-500 max-w-[200px] truncate" title="${notesText}">${notesText}</td>
                                        <td class="p-3 status-cell">${statusBadge}</td>
                                        <td class="p-3 text-right actions-cell">${actionButton}</td>
                                    </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;
            lucide.createIcons();
        };
        
        App.getOrderStatusBadgeHTML = (order) => {
            const statusMap = {
                'Pendente': 'bg-yellow-100 text-yellow-800', 'Entregue': 'bg-green-100 text-green-800',
                'Cancelado': 'bg-red-100 text-red-800', 'Reembolsado': 'bg-purple-100 text-purple-800',
            };
            if(order.is_internal_consumption) return `<span class="px-2.5 py-1 text-xs font-semibold rounded-full bg-indigo-100 text-indigo-800">Finalizado</span>`;
            return `<span class="px-2.5 py-1 text-xs font-semibold rounded-full ${statusMap[order.status] || 'bg-gray-100 text-gray-800'}">${order.status || 'Pendente'}</span>`;
        };

        App.getOrderActionsHTML = (order) => {
            if (order.status === 'Entregue' && !order.is_internal_consumption) {
                return `<button data-id="${order.id}" data-value="${order.total_value}" class="refund-order-btn bg-purple-100 text-purple-700 px-3 py-1.5 rounded-lg text-xs font-semibold hover:bg-purple-200 transition-colors">Reembolsar</button>`;
            }
            return '';
        };

        App.renderInventory = () => {
            const page = document.getElementById('page-inventory');
            page.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-1"><form id="ingredient-form" class="bg-white p-6 rounded-xl shadow-sm space-y-4"><h3 id="ingredient-form-title" class="text-base font-semibold">Novo Ingrediente</h3><input type="hidden" id="ingredient-id"><div><label for="ingredient-name" class="block text-xs font-medium text-slate-600">Nome</label><input type="text" id="ingredient-name" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div><div class="grid grid-cols-2 gap-4"><div><label for="ingredient-stock" class="block text-xs font-medium text-slate-600">Qtd. em Estoque</label><input type="number" step="0.001" id="ingredient-stock" required class="mt-1 block w-full p-2.5 border rounded-lg text-sm"></div><div><label for="ingredient-unit" class="block text-xs font-medium text-slate-600">Unidade</label><select id="ingredient-unit" required class="mt-1 block w-full p-2.5 border rounded-lg text-sm"><option>kg</option><option>g</option><option>un</option><option>L</option><option>ml</option></select></div></div><div><label for="ingredient-min-stock" class="block text-xs font-medium text-slate-600">Estoque Mínimo</label><input type="number" step="0.001" id="ingredient-min-stock" required class="mt-1 block w-full p-2.5 border rounded-lg text-sm"></div><div class="flex space-x-3 pt-2"><button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-sm">Salvar</button><button type="button" id="cancel-edit-ingredient-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hidden hover:bg-slate-300 transition-colors text-sm">Cancelar</button></div></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm"><h3 class="text-base font-semibold mb-4">Ingredientes Registados</h3><div id="ingredients-list-container" class="overflow-x-auto"></div></div></div>`;
            App.renderIngredientsList();
        };
        App.renderIngredientsList = () => {
            const container = document.getElementById('ingredients-list-container');
            if(!container) return;
            if (App.state.ingredients.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhum ingrediente registado.</p>`; return; }
            container.innerHTML = `<table class="w-full text-left min-w-[500px] text-sm"><thead class="border-b border-slate-200"><tr class="text-xs text-slate-500"><th class="p-2 font-semibold">Nome</th><th class="p-2 font-semibold">Estoque</th><th class="p-2 font-semibold">Mínimo</th><th class="p-2 font-semibold text-right">Ações</th></tr></thead><tbody>${App.state.ingredients.map(i => { const isLow = i.stock_quantity < i.min_stock_quantity; return `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="p-3">${i.name}</td><td class="p-3 ${isLow ? 'text-red-500 font-bold' : ''}">${i.stock_quantity} ${i.unit}</td><td class="p-3">${i.min_stock_quantity} ${i.unit}</td><td class="p-3 text-right"><div class="flex justify-end space-x-1"><button data-id="${i.id}" class="edit-ingredient-btn p-1.5 text-slate-500 hover:text-indigo-600 rounded-md transition-colors"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button><button data-id="${i.id}" class="delete-ingredient-btn p-1.5 text-slate-500 hover:text-red-600 rounded-md transition-colors"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div></td></tr>`}).join('')}</tbody></table>`;
            lucide.createIcons();
        };
        App.renderFinancials = () => {
            const page = document.getElementById('page-financials');
            const isPersonalMode = App.state.viewMode === 'pessoal';

            if(isPersonalMode) {
                const totalIncome = App.state.personalIncomes.reduce((sum, income) => sum + income.amount, 0);
                const totalExpenses = App.state.expenses.filter(e => e.type === 'pessoal').reduce((sum, expense) => sum + expense.amount, 0);
                const balance = totalIncome - totalExpenses;
                page.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2></h2>
                        <div class="flex gap-2">
                             <button id="add-personal-income-btn" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors flex items-center gap-2 text-sm"><i data-lucide="plus" class="w-4 h-4"></i>Receita</button>
                            <button id="add-personal-expense-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2 text-sm"><i data-lucide="minus" class="w-4 h-4"></i>Despesa</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500"><h3 class="text-xs font-medium text-slate-500">Receita Pessoal</h3><p class="text-2xl font-bold text-slate-800 mt-1">${App.formatCurrency(totalIncome)}</p></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500"><h3 class="text-xs font-medium text-slate-500">Despesa Pessoal</h3><p class="text-2xl font-bold text-slate-800 mt-1">${App.formatCurrency(totalExpenses)}</p></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500"><h3 class="text-xs font-medium text-slate-500">Balanço Pessoal</h3><p class="text-2xl font-bold text-slate-800 mt-1">${App.formatCurrency(balance)}</p></div>
                    </div>
                     <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-base font-semibold mb-4">Histórico de Receitas</h3><div id="personal-incomes-list-container" class="overflow-y-auto"></div></div>
                        <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="text-base font-semibold mb-4">Histórico de Despesas</h3><div id="personal-expenses-list-container" class="overflow-y-auto"></div></div>
                    </div>
                `;
                App.renderPersonalFinancialsLists();
            } else {
                 const totalRevenue = App.state.orders.filter(o => o.status === 'Entregue' && !o.is_internal_consumption).reduce((sum, order) => sum + order.total_value, 0);
                 const totalExpenses = App.state.expenses.filter(e => e.type === 'empresa').reduce((sum, expense) => sum + expense.amount, 0);
                 const balance = totalRevenue - totalExpenses;
                 page.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800">Resumo da Empresa</h2>
                        <button id="add-business-expense-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2 text-sm"><i data-lucide="minus-circle" class="w-4 h-4"></i>Nova Despesa</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-green-500"><h3 class="text-xs font-medium text-slate-500">Receita (Pedidos Entregues)</h3><p class="text-2xl font-bold text-slate-800 mt-1">${App.formatCurrency(totalRevenue)}</p></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500"><h3 class="text-xs font-medium text-slate-500">Despesa da Empresa</h3><p class="text-2xl font-bold text-slate-800 mt-1">${App.formatCurrency(totalExpenses)}</p></div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-blue-500"><h3 class="text-xs font-medium text-slate-500">Balanço da Empresa</h3><p class="text-2xl font-bold text-slate-800 mt-1">${App.formatCurrency(balance)}</p></div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-base font-semibold mb-4">Histórico de Despesas da Empresa</h3>
                        <div id="business-expenses-list-container" class="overflow-x-auto"></div>
                    </div>`;
                App.renderBusinessExpensesList();
            }
        };
        App.renderPersonalFinancialsLists = () => {
             const incomesContainer = document.getElementById('personal-incomes-list-container');
             const expensesContainer = document.getElementById('personal-expenses-list-container');
             const personalIncomes = App.state.personalIncomes;
             const personalExpenses = App.state.expenses.filter(e => e.type === 'pessoal');

             if(incomesContainer) {
                 if (personalIncomes.length === 0) { incomesContainer.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhuma receita pessoal.</p>`; }
                 else { incomesContainer.innerHTML = `<table class="w-full text-left min-w-[300px] text-sm"><thead class="border-b border-slate-200"><tr class="text-xs text-slate-500"><th class="p-2 font-semibold">Data</th><th class="p-2 font-semibold">Descrição</th><th class="p-2 font-semibold text-right">Valor</th></tr></thead><tbody>${personalIncomes.map(e => `<tr class="border-b border-slate-100"><td class="p-2">${App.formatDate(e.date)}</td><td class="p-2">${e.description}</td><td class="p-2 font-medium text-right">${App.formatCurrency(e.amount)}</td></tr>`).join('')}</tbody></table>`; }
             }
             if(expensesContainer) {
                 if (personalExpenses.length === 0) { expensesContainer.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhuma despesa pessoal.</p>`; }
                 else { expensesContainer.innerHTML = `<table class="w-full text-left min-w-[300px] text-sm"><thead class="border-b border-slate-200"><tr class="text-xs text-slate-500"><th class="p-2 font-semibold">Data</th><th class="p-2 font-semibold">Descrição</th><th class="p-2 font-semibold text-right">Valor</th></tr></thead><tbody>${personalExpenses.map(e => `<tr class="border-b border-slate-100"><td class="p-2">${App.formatDate(e.date)}</td><td class="p-2">${e.description}</td><td class="p-2 font-medium text-right">${App.formatCurrency(e.amount)}</td></tr>`).join('')}</tbody></table>`; }
             }
        };

        App.renderBusinessExpensesList = () => {
            const container = document.getElementById('business-expenses-list-container');
            if(!container) return;
            const businessExpenses = App.state.expenses.filter(e => e.type === 'empresa');
            if (businessExpenses.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhuma despesa da empresa registada.</p>`; return; }
            container.innerHTML = `<table class="w-full text-left min-w-[400px] text-sm"><thead class="border-b border-slate-200"><tr class="text-xs text-slate-500"><th class="p-2 font-semibold">Data</th><th class="p-2 font-semibold">Descrição</th><th class="p-2 font-semibold">Valor</th><th class="p-2 font-semibold text-right">Ações</th></tr></thead><tbody>${businessExpenses.map(e => `<tr class="border-b border-slate-100 hover:bg-slate-50"><td class="p-3">${App.formatDate(e.date)}</td><td class="p-3">${e.description}</td><td class="p-3 font-medium">${App.formatCurrency(e.amount)}</td><td class="p-3 text-right"><button data-id="${e.id}" class="delete-expense-btn p-1.5 text-slate-500 hover:text-red-600 rounded-md transition-colors" title="Excluir"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></td></tr>`).join('')}</tbody></table>`;
            lucide.createIcons();
        };
        
        App.renderMotoboysPage = () => {
            const page = document.getElementById('page-motoboys');
            page.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1">
                        <form id="motoboy-form" class="bg-white p-6 rounded-xl shadow-sm space-y-4">
                            <h3 id="motoboy-form-title" class="text-base font-semibold">Novo Motoboy</h3>
                            <input type="hidden" id="motoboy-id">
                            <div>
                                <label for="motoboy-name" class="block text-xs font-medium text-slate-600">Nome do Motoboy</label>
                                <input type="text" id="motoboy-name" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label for="motoboy-plate" class="block text-xs font-medium text-slate-600">Placa da Moto (Opcional)</label>
                                <input type="text" id="motoboy-plate" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                            </div>
                            <div class="flex space-x-3 pt-2">
                                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors hover:bg-indigo-700 text-sm">Salvar Motoboy</button>
                                <button type="button" id="cancel-edit-motoboy-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hidden hover:bg-slate-300 text-sm">Cancelar</button>
                            </div>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                        <h3 class="text-base font-semibold mb-4">Motoboys Registados</h3>
                        <div id="motoboys-list-container"></div>
                    </div>
                </div>`;
            App.renderMotoboysList();
        };

        App.renderMotoboysList = () => {
             const container = document.getElementById('motoboys-list-container');
             if(!container) return;
             if (App.state.motoboys.length === 0) { container.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhum motoboy registado.</p>`; return; }
             container.innerHTML = `<ul class="divide-y divide-slate-100">${App.state.motoboys.map(m => `<li class="py-2.5 flex justify-between items-center"><div><p class="font-semibold text-slate-800 text-sm">${m.name}</p><p class="text-xs text-slate-500">${m.license_plate || 'Sem placa'}</p></div><div class="flex items-center space-x-1"><button data-id="${m.id}" class="edit-motoboy-btn p-1.5 text-slate-500 hover:text-indigo-600 rounded-md"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button><button data-id="${m.id}" class="delete-motoboy-btn p-1.5 text-slate-500 hover:text-red-600 rounded-md"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button></div></li>`).join('')}</ul>`;
             lucide.createIcons();
        };
        
        App.renderMotoboyPaymentsContainer = () => {
            const container = document.getElementById('motoboy-payments-container');
            if(!container) return;
            const unpaidDeliveries = App.state.orders.filter(o => o.is_delivery && o.delivery_cost > 0 && !o.delivery_fee_paid && o.motoboy_id);
            
            const paymentsByMotoboy = App.state.motoboys.map(motoboy => {
                const deliveries = unpaidDeliveries.filter(d => d.motoboy_id === motoboy.id);
                const totalToPay = deliveries.reduce((sum, d) => sum + d.delivery_cost, 0);
                return { ...motoboy, totalToPay, deliveryIds: deliveries.map(d => d.id) };
            }).filter(m => m.totalToPay > 0);

            if (paymentsByMotoboy.length === 0) {
                container.innerHTML = `<p class="text-slate-500 text-center py-8 text-sm">Nenhum pagamento pendente.</p>`;
                return;
            }
            container.innerHTML = `<ul class="divide-y divide-slate-200">${paymentsByMotoboy.map(m => `<li class="py-3 flex justify-between items-center"><div><p class="font-semibold text-slate-800 text-sm">${m.name}</p><p class="text-xs text-slate-500">${m.deliveryIds.length} entregas</p></div><div class="flex items-center gap-3"><span class="font-semibold text-base text-green-600">${App.formatCurrency(m.totalToPay)}</span><button data-id="${m.id}" data-amount="${m.totalToPay}" data-delivery-ids='${JSON.stringify(m.deliveryIds)}' class="pay-motoboy-btn bg-green-100 text-green-700 font-semibold px-3 py-1.5 rounded-lg hover:bg-green-200 transition-colors text-xs">Pagar</button></div></li>`).join('')}</ul>`;
        };
        
        // --- HANDLERS (Ações e Formulários) ---
        App.handleCustomerFormSubmit = async (e) => { e.preventDefault(); App.showLoading(); const id = App.editingId.customer; const d = { name: document.getElementById('customer-name').value.trim(), phone: document.getElementById('customer-phone').value.trim(), address: document.getElementById('customer-address').value.trim(), numero: document.getElementById('customer-number').value.trim(), complemento: document.getElementById('customer-complement').value.trim(), bairro: document.getElementById('customer-neighborhood').value.trim(), user_id: App.state.currentUser.id }; const { error } = id ? await db.from('customers').update(d).eq('id', id) : await db.from('customers').insert(d); if (error) App.showToast(`Erro: ${error.message}`, true); else { App.showToast(`Cliente ${id ? 'atualizado' : 'salvo'}!`); App.resetCustomerForm(); await App.loadData(); App.navigateTo('customers'); } App.hideLoading(); };
        App.resetCustomerForm = () => { if(document.getElementById('customer-form')) { document.getElementById('customer-form').reset(); document.getElementById('customer-form-title').textContent = 'Novo Cliente'; document.getElementById('cancel-edit-customer-btn').classList.add('hidden'); App.editingId.customer = null; }};
        App.editCustomer = (id) => { const c = App.state.customers.find(c => c.id === id); if (!c) return; App.editingId.customer = id; document.getElementById('customer-form-title').textContent = 'Editar Cliente'; document.getElementById('customer-name').value = c.name; document.getElementById('customer-phone').value = c.phone || ''; document.getElementById('customer-address').value = c.address || ''; document.getElementById('customer-number').value = c.numero || ''; document.getElementById('customer-complement').value = c.complemento || ''; document.getElementById('customer-neighborhood').value = c.bairro || ''; document.getElementById('cancel-edit-customer-btn').classList.remove('hidden'); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        App.deleteCustomer = (id) => { App.showConfirmation('Excluir Cliente', 'Tem a certeza de que deseja excluir este cliente? Esta ação não pode ser desfeita.', async () => { App.showLoading(); const { error } = await db.from('customers').delete().eq('id', id); if (error) { App.showToast(`Erro: ${error.message}`, true); } else { App.showToast('Cliente apagado.'); await App.loadData(); App.navigateTo('customers'); } App.hideLoading(); }); };
        
        App.handleProductFormSubmit = async (e) => { e.preventDefault(); App.showLoading(); const id = App.editingId.product; let imageUrl = document.getElementById('product-image-preview').src; if (imageUrl.startsWith('https://placehold.co')) { imageUrl = null; } if (App.state.productFormImageFile) { const filePath = `public/${App.state.currentUser.id}/${Date.now()}-${App.state.productFormImageFile.name}`; const { error: uploadError } = await db.storage.from('productimages').upload(filePath, App.state.productFormImageFile); if (uploadError) { App.showToast(`Erro no upload: ${uploadError.message}`, true); App.hideLoading(); return; } const { data: { publicUrl } } = db.storage.from('productimages').getPublicUrl(filePath); imageUrl = publicUrl; } const priceValue = App.getNumericValue(document.getElementById('product-price').value); const d = { name: document.getElementById('product-name').value.trim(), price: priceValue, category: document.getElementById('product-category').value, image_url: imageUrl, user_id: App.state.currentUser.id, is_active: true }; if(isNaN(d.price)) { App.showToast('Preço inválido', true); App.hideLoading(); return; } const { error } = id ? await db.from('products').update(d).eq('id', id) : await db.from('products').insert(d); if (error) { App.showToast(`Erro: ${error.message}`, true); } else { App.showToast(`Produto ${id ? 'atualizado' : 'salvo'}!`); App.resetProductForm(); await App.loadData(); App.navigateTo('products'); } App.hideLoading(); };
        App.resetProductForm = () => { if(document.getElementById('product-form')) { document.getElementById('product-form').reset(); document.getElementById('product-form-title').textContent = 'Novo Produto'; document.getElementById('cancel-edit-product-btn').classList.add('hidden'); const preview = document.getElementById('product-image-preview'); const placeholder = document.getElementById('product-image-placeholder'); const loader = document.getElementById('product-image-loader'); preview.classList.add('hidden'); preview.src = ""; placeholder.classList.remove('hidden'); loader.classList.add('hidden'); App.editingId.product = null; App.state.productFormImageFile = null; }};
        App.editProduct = (id) => { const p = App.state.products.find(p => p.id === id); if (!p) return; App.editingId.product = id; App.state.productFormImageFile = null; document.getElementById('product-form-title').textContent = 'Editar Produto'; document.getElementById('product-name').value = p.name; document.getElementById('product-price').value = App.formatCurrency(p.price); document.getElementById('product-category').value = p.category || 'principal'; const preview = document.getElementById('product-image-preview'); const placeholder = document.getElementById('product-image-placeholder'); if (p.image_url) { preview.src = p.image_url; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); } else { preview.src = ""; preview.classList.add('hidden'); placeholder.classList.remove('hidden'); } document.getElementById('cancel-edit-product-btn').classList.remove('hidden'); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        App.deactivateProduct = (id) => { App.showConfirmation('Desativar Produto?', 'O produto não aparecerá em novos pedidos, mas o histórico será mantido. Deseja continuar?', async () => { App.showLoading(); const { error } = await db.from('products').update({ is_active: false }).eq('id', id); if (error) { App.showToast(error.message, true); } else { App.showToast('Produto desativado.'); await App.loadData(); App.renderProductsList(); } App.hideLoading(); }); };
        App.activateProduct = async (id) => { App.showLoading(); const { error } = await db.from('products').update({ is_active: true }).eq('id', id); if (error) { App.showToast(error.message, true); } else { App.showToast('Produto reativado.'); await App.loadData(); App.renderProductsList(); } App.hideLoading(); };

        App.handleIngredientFormSubmit = async (e) => { e.preventDefault(); App.showLoading(); const id = App.editingId.ingredient; const d = { name: document.getElementById('ingredient-name').value.trim(), stock_quantity: parseFloat(document.getElementById('ingredient-stock').value), unit: document.getElementById('ingredient-unit').value, min_stock_quantity: parseFloat(document.getElementById('ingredient-min-stock').value), user_id: App.state.currentUser.id }; const { error } = id ? await db.from('ingredients').update(d).eq('id', id) : await db.from('ingredients').insert(d); if (error) App.showToast(`Erro: ${error.message}`, true); else { App.showToast(`Ingrediente ${id ? 'atualizado' : 'salvo'}!`); App.resetIngredientForm(); await App.loadData(); App.navigateTo('inventory'); } App.hideLoading(); };
        App.resetIngredientForm = () => { if(document.getElementById('ingredient-form')) { document.getElementById('ingredient-form').reset(); document.getElementById('ingredient-form-title').textContent = 'Novo Ingrediente'; document.getElementById('cancel-edit-ingredient-btn').classList.add('hidden'); App.editingId.ingredient = null; }};
        App.editIngredient = (id) => { const i = App.state.ingredients.find(i => i.id === id); if (!i) return; App.editingId.ingredient = id; document.getElementById('ingredient-form-title').textContent = 'Editar Ingrediente'; document.getElementById('ingredient-name').value = i.name; document.getElementById('ingredient-stock').value = i.stock_quantity; document.getElementById('ingredient-unit').value = i.unit; document.getElementById('ingredient-min-stock').value = i.min_stock_quantity; document.getElementById('cancel-edit-ingredient-btn').classList.remove('hidden'); window.scrollTo({ top: 0, behavior: 'smooth' }); };
        App.deleteIngredient = (id) => { App.showConfirmation('Excluir Ingrediente', 'Tem a certeza de que deseja excluir este ingrediente?', async () => { App.showLoading(); const { error } = await db.from('ingredients').delete().eq('id', id); if (error) { App.showToast(`Erro: ${error.message}`, true); } else { App.showToast('Ingrediente apagado.'); await App.loadData(); App.navigateTo('inventory'); } App.hideLoading(); }); };
        
        App.handleMotoboyFormSubmit = async (e) => { e.preventDefault(); App.showLoading(); const id = Number(document.getElementById('motoboy-id').value); const d = { name: document.getElementById('motoboy-name').value.trim(), license_plate: document.getElementById('motoboy-plate').value.trim(), user_id: App.state.currentUser.id }; const { error } = id ? await db.from('motoboys').update(d).eq('id', id) : await db.from('motoboys').insert(d); if (error) { App.showToast(`Erro: ${error.message}`, true); } else { App.showToast(`Motoboy ${id ? 'atualizado' : 'salvo'}!`); App.resetMotoboyForm(); await App.loadData(); App.renderMotoboysPage(); } App.hideLoading(); };
        App.resetMotoboyForm = () => { if(document.getElementById('motoboy-form')) { document.getElementById('motoboy-form').reset(); document.getElementById('motoboy-id').value = ''; document.getElementById('cancel-edit-motoboy-btn').classList.add('hidden'); }};
        App.editMotoboy = (id) => { const m = App.state.motoboys.find(m => m.id === id); if (!m) return; document.getElementById('motoboy-id').value = m.id; document.getElementById('motoboy-name').value = m.name; document.getElementById('motoboy-plate').value = m.license_plate; document.getElementById('cancel-edit-motoboy-btn').classList.remove('hidden'); document.getElementById('motoboy-name').focus(); };
        App.deleteMotoboy = (id) => { App.showConfirmation('Excluir Motoboy', 'Tem a certeza de que deseja excluir este motoboy?', async () => { App.showLoading(); const { error } = await db.from('motoboys').delete().eq('id', id); if (error) { App.showToast(`Erro: ${error.message}`, true); } else { App.showToast('Motoboy apagado.'); await App.loadData(); App.renderMotoboysPage(); } App.hideLoading(); }); };
        
        App.handlePayMotoboy = async (motoboyId, amount, deliveryIds) => {
            App.showConfirmation('Confirmar Pagamento', `Tem a certeza que deseja pagar ${App.formatCurrency(amount)} a este motoboy?`, async () => {
                App.showLoading();
                const { data: { user } } = await db.auth.getUser();
                const motoboy = App.state.motoboys.find(m => m.id === motoboyId);
                const expenseData = { description: `Pagamento taxas motoboy: ${motoboy.name}`, amount: parseFloat(amount), date: new Date().toISOString().slice(0, 10), user_id: user.id, type: 'empresa' };
                
                const { error: expenseError } = await db.from('expenses').insert(expenseData);
                if (expenseError) { App.showToast(`Erro ao criar despesa: ${expenseError.message}`, true); App.hideLoading(); return; }

                const { error: updateError } = await db.from('orders').update({ delivery_fee_paid: true }).in('id', deliveryIds);
                if (updateError) { App.showToast(`Erro ao atualizar pedidos: ${updateError.message}`, true); }
                else { App.showToast(`Pagamento para ${motoboy.name} registado com sucesso!`); }

                await App.loadData();
                App.navigateTo('dashboard');
                App.hideLoading();
            });
        };

        App.handleExpenseFormSubmit = async (e) => {
            e.preventDefault();
            App.showLoading();
            const { data: { user } } = await db.auth.getUser();
            const amountValue = App.getNumericValue(document.getElementById('modal-expense-amount').value);
            const description = document.getElementById('modal-expense-description').value.trim();
            const type = e.target.dataset.type;
            const expenseData = {
                description: description, amount: amountValue,
                date: document.getElementById('modal-expense-date').value, user_id: user?.id, type: type
            };
            if (!expenseData.description || isNaN(expenseData.amount) || expenseData.amount <= 0 || !expenseData.date) { App.showToast('Preencha todos os campos corretamente.', true); App.hideLoading(); return; }
            const { error: expenseError } = await db.from('expenses').insert(expenseData);
            if (expenseError) { App.showToast(`Erro ao salvar despesa: ${expenseError.message}`, true); App.hideLoading(); return; }
            const isProlabore = expenseData.description.toLowerCase() === 'pró-labore' && expenseData.type === 'empresa';
            if (isProlabore) {
                const incomeData = { description: 'Pró-labore', amount: expenseData.amount, date: expenseData.date, user_id: user?.id };
                const { error: incomeError } = await db.from('personal_incomes').insert(incomeData);
                if (incomeError) { App.showToast(`Despesa salva, mas falha ao adicionar receita pessoal: ${incomeError.message}`, true); } 
                else { App.showToast('Pró-labore registrado como despesa e receita pessoal!'); }
            } else { App.showToast('Despesa salva!'); }
            await App.loadData(); App.closeAllModals();
            if (document.getElementById('page-financials')?.offsetParent) { App.renderFinancials(); }
            App.hideLoading();
        };
        App.handlePersonalIncomeSubmit = async (e) => { e.preventDefault(); App.showLoading(); const { data: { user } } = await db.auth.getUser(); const amountValue = App.getNumericValue(document.getElementById('modal-income-amount').value); const d = { description: document.getElementById('modal-income-description').value.trim(), amount: amountValue, date: document.getElementById('modal-income-date').value, user_id: user?.id }; if(!d.description || isNaN(d.amount) || d.amount <= 0 || !d.date) { App.showToast('Preencha todos os campos corretamente.', true); App.hideLoading(); return; } const { error } = await db.from('personal_incomes').insert(d); if (error) { App.showToast(`Erro: ${error.message}`, true); } else { App.showToast('Receita salva!'); await App.loadData(); App.closeAllModals(); if (document.getElementById('page-financials')?.offsetParent) { App.renderFinancials(); } } App.hideLoading(); };
        App.deleteExpense = async (id) => { App.showConfirmation('Excluir Despesa', 'Tem a certeza de que deseja excluir esta despesa?', async () => { App.showLoading(); const { error } = await db.from('expenses').delete().eq('id', id); if(error) { App.showToast(error.message, true); } else { App.showToast('Despesa apagada.'); await App.loadData(); App.navigateTo('financials'); } App.hideLoading(); }); };
        
        App.handleMarkAsDelivered = async(orderId, motoboyId = null) => { 
            App.showLoading(); 
            const order = App.state.orders.find(o => o.id === orderId);
            const updateData = { status: 'Entregue' };
            if (motoboyId) { updateData.motoboy_id = motoboyId; }
            const { error } = await db.from('orders').update(updateData).eq('id', orderId); 
            if (error) { App.showToast(error.message, true); App.hideLoading(); } 
            else { 
                App.showSaleNotification(order.total_value);
                setTimeout(async () => { await App.loadData(); App.navigateTo('deliveries'); App.hideLoading(); }, 1000);
            } 
        };
        App.handleCancelOrder = async(orderId) => { App.showConfirmation('Cancelar Pedido', 'Tem a certeza de que deseja cancelar este pedido?', async () => { App.showLoading(); const { error } = await db.from('orders').update({ status: 'Cancelado' }).eq('id', orderId); if (error) { App.showToast(error.message, true); } else { App.showToast("Pedido cancelado."); await App.loadData(); App.navigateTo('deliveries'); } App.hideLoading(); }); };
        
        App.showRefundConfirmation = (buttonEl) => {
            const orderId = Number(buttonEl.dataset.id);
            const orderValue = buttonEl.dataset.value;
            const row = buttonEl.closest('tr[data-order-id]');
            if (!row) return;

            const statusCell = row.querySelector('.status-cell');
            const actionsCell = row.querySelector('.actions-cell');
            if (statusCell) statusCell.innerHTML = '';
            if (actionsCell) {
                actionsCell.innerHTML = `
                    <div class="flex justify-end items-center gap-2">
                        <button data-id="${orderId}" class="cancel-refund-btn bg-slate-200 text-slate-800 font-semibold py-1.5 px-3 rounded-lg hover:bg-slate-300 transition-colors text-xs">Voltar atrás</button>
                        <button data-id="${orderId}" data-value="${orderValue}" class="confirm-refund-btn bg-purple-100 text-purple-700 font-semibold py-1.5 px-3 rounded-lg hover:bg-purple-200 transition-colors text-xs">Confirmar</button>
                    </div>
                `;
            }
        };
        
        App.cancelRefundConfirmation = (buttonEl) => {
            const orderId = Number(buttonEl.dataset.id);
            const row = buttonEl.closest('tr[data-order-id]');
            const order = App.state.orders.find(o => o.id === orderId);
            if (!order || !row) return;

            const statusCell = row.querySelector('.status-cell');
            const actionsCell = row.querySelector('.actions-cell');
            
            if(statusCell) statusCell.innerHTML = App.getOrderStatusBadgeHTML(order);
            if(actionsCell) actionsCell.innerHTML = App.getOrderActionsHTML(order);
            
            lucide.createIcons();
        };

        App.handleRefundOrder = async(orderId, amount) => {
            App.showConfirmation('Confirmar Reembolso', `Tem a certeza que deseja reembolsar este pedido no valor de ${App.formatCurrency(amount)}?`, async () => {
                App.showLoading();
                const { data: { user } } = await db.auth.getUser();
                if (!user) { App.showToast('Utilizador não autenticado.', true); App.hideLoading(); return; }

                const expenseData = { description: `Reembolso do Pedido #${orderId}`, amount: parseFloat(amount), date: new Date().toISOString().slice(0, 10), user_id: user.id, type: 'empresa' };
                const { error: expenseError } = await db.from('expenses').insert(expenseData);
                if (expenseError) { App.showToast(`Erro ao criar despesa de reembolso: ${expenseError.message}`, true); App.hideLoading(); return; }

                const { error: orderError } = await db.from('orders').update({ status: 'Reembolsado' }).eq('id', orderId);
                if (orderError) { App.showToast(orderError.message, true); } 
                else { App.showToast("Pedido reembolsado com sucesso!"); await App.loadData(); App.navigateTo('history'); }
                App.hideLoading();
            });
        };
        
        App.handleEditOrder = async (orderId) => {
            const order = App.state.orders.find(o => o.id === orderId);
            if (!order) { App.showToast("Pedido não encontrado.", true); return; }

            const items = App.state.orderItems.filter(item => item.order_id === orderId).map(item => ({
                product_id: item.product_id, name: item.products.name, quantity: item.quantity, price: item.unit_price
            }));

            App.state.editingOrderId = orderId;
            App.state.currentOrder = {
                customer_id: order.customer_id, items: items, total: order.total_value, payment_method: order.payment_method,
                status: order.status, is_delivery: order.is_delivery, notes: order.notes || '',
                delivery_cost: order.delivery_cost || 0, step: 1, is_internal_consumption: order.is_internal_consumption
            };
            App.openOrderModal();
        };

        // --- LÓGICA DE MODAIS ---
        App.closeAllModals = () => {
            document.querySelectorAll('.modal-container').forEach(modal => {
                const modalContent = modal.querySelector('.modal-content');
                if(modalContent) modalContent.classList.remove('open');
                modal.classList.remove('open');
            });
            App.resetCurrentOrder();
            App.state.importedImageData = null;
            App.state.scannedProducts = [];
        };

        App.showConfirmation = (title, message, onConfirm) => {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = modal.querySelector('.modal-content');
            modal.querySelector('#confirm-title').textContent = title;
            modal.querySelector('#confirm-message').textContent = message;
            App.confirmAction = onConfirm; 
            modal.classList.add('open');
            modalContent.classList.add('open');
            document.getElementById('confirm-cancel-btn').onclick = () => App.closeAllModals();
            document.getElementById('confirm-action-btn').onclick = () => { App.closeAllModals(); if (App.confirmAction) { App.confirmAction(); } };
        };

        App.openOrderModal = () => {
             const { activeCashSession } = App.state;
             if (!activeCashSession && !App.state.editingOrderId) {
                App.showToast("O caixa está fechado. Abra o caixa para lançar um novo pedido.", true); return;
            }
            const orderCreationModal = document.getElementById('order-creation-modal');
            const orderModalContent = orderCreationModal.querySelector('.modal-content');
            orderCreationModal.classList.add('open');
            orderModalContent.classList.add('open');
            App.renderOrderCreationUI();
        };
        
        App.openExpenseModal = (type = 'empresa') => {
            const expenseCreationModal = document.getElementById('expense-creation-modal');
            expenseCreationModal.classList.add('open');
            expenseCreationModal.querySelector('.modal-content').classList.add('open');
            App.renderExpenseCreationUI(type);
        };
        
        App.openPersonalIncomeModal = () => {
            const personalIncomeModal = document.getElementById('personal-income-modal');
            personalIncomeModal.classList.add('open');
            personalIncomeModal.querySelector('.modal-content').classList.add('open');
            App.renderPersonalIncomeCreationUI();
        };
        
        App.openAssignMotoboyModal = (orderId) => {
            const assignMotoboyModal = document.getElementById('assign-motoboy-modal');
            const modalContent = assignMotoboyModal.querySelector('.modal-content');
            assignMotoboyModal.classList.add('open');
            modalContent.classList.add('open');
            modalContent.innerHTML = `
                <div class="p-6">
                    <h3 class="text-base font-semibold mb-4">Atribuir Motoboy</h3>
                    <form id="assign-motoboy-form" data-order-id="${orderId}">
                        <select id="motoboy-select" class="w-full p-2.5 border border-slate-300 rounded-lg text-sm">
                            <option value="">Selecione um motoboy...</option>
                            ${App.state.motoboys.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
                        </select>
                        <div class="grid grid-cols-2 gap-3 pt-6">
                            <button type="button" id="cancel-assign-btn" class="bg-slate-200 font-semibold py-2.5 rounded-lg text-sm">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-2.5 rounded-lg text-sm">Confirmar</button>
                        </div>
                    </form>
                </div>
            `;
            lucide.createIcons();
        };
        
        App.openImageImportModal = (importType) => {
            const modal = document.getElementById('image-import-modal');
            if (!modal) return;
            App.state.currentImportType = importType;
            App.renderImageImportUI('uploader');
            modal.classList.add('open');
            modal.querySelector('.modal-content').classList.add('open');
        };

        App.renderImageImportUI = (view, data = null) => {
            const modalContent = document.getElementById('image-import-modal').querySelector('.modal-content');
            let contentHTML = '';
            
            const header = (title, description) => `
                <div class="p-6 sm:p-8 flex-shrink-0">
                    <div class="flex justify-between items-start">
                        <h2 class="text-xl font-bold text-slate-800">${title}</h2>
                        <button id="close-import-modal-btn" class="p-2 -mr-2 -mt-2 rounded-full hover:bg-slate-100 transition-colors">
                            <i data-lucide="x" class="w-6 h-6 text-slate-500"></i>
                        </button>
                    </div>
                    <p class="text-slate-500 mt-1 text-sm">${description}</p>
                </div>`;
            
            switch(view) {
                case 'uploader':
                    contentHTML = `${header('Importar com IA', 'Tire uma foto ou carregue uma imagem do seu cardápio ou recibo.')}
                        <div class="p-6 sm:p-8 pt-0 flex-1 flex flex-col"><div id="image-uploader-section" class="flex-1 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 rounded-lg p-8 text-center"><i data-lucide="upload-cloud" class="w-12 h-12 text-slate-400 mb-4"></i><h3 class="font-semibold text-slate-800 text-sm">Arraste e solte uma imagem aqui</h3><p class="text-xs text-slate-500">ou</p><input type="file" id="image-import-input" class="hidden" accept="image/*"><label for="image-import-input" class="mt-2 bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors cursor-pointer text-sm">Escolher Ficheiro</label><p class="text-xs text-slate-400 mt-4">PNG, JPG, GIF até 10MB</p></div><div id="image-preview-section" class="hidden flex-1 flex-col items-center"><img id="image-preview" src="#" alt="Image Preview" class="max-h-56 w-auto rounded-lg shadow-md mb-4"/></div><div class="grid grid-cols-2 gap-3 pt-6 mt-auto"><button type="button" id="cancel-import-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 text-sm">Cancelar</button><button type="button" id="start-analysis-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed text-sm" disabled>Analisar Imagem</button></div></div>`;
                    break;
                case 'processing':
                    contentHTML = `<div class="p-6 sm:p-8 flex-1 flex flex-col items-center justify-center text-center"><div class="loader"></div><p class="text-slate-500 mt-4 text-base">A analisar a imagem... Aguarde.</p><p class="text-sm text-slate-400">A nossa IA está a ler os dados para si.</p></div>`;
                    break;
                case 'verification':
                    contentHTML = `${header('Verificar Itens Importados', 'Confirme os produtos e preços encontrados. Pode editá-los antes de importar.')}
                        <form id="import-verification-form" class="flex-1 overflow-y-auto px-6 sm:px-8 space-y-3"><table class="w-full text-left text-sm"><thead class="border-b-2 border-slate-200"><tr class="text-xs text-slate-500"><th class="p-2 w-10"><input type="checkbox" id="select-all-scanned" checked class="w-4 h-4 rounded"></th><th class="p-2">Produto</th><th class="p-2">Preço</th><th class="p-2">Categoria</th></tr></thead><tbody class="divide-y divide-slate-100">
                        ${data.map((item, index) => `
                            <tr class="scanned-item-row"><td class="p-2"><input type="checkbox" name="scanned_item_check" checked class="w-4 h-4 rounded"></td><td class="p-2"><input type="text" name="scanned_item_name" value="${item.name || ''}" class="w-full p-2 border border-slate-300 rounded-md text-sm"></td><td class="p-2"><input type="text" name="scanned_item_price" value="${App.formatCurrency(item.price)}" class="w-full p-2 border border-slate-300 rounded-md text-sm" inputmode="decimal"></td><td class="p-2"><select name="scanned_item_category" class="w-full p-2 border border-slate-300 rounded-md bg-white text-sm"><option value="principal" ${item.category === 'principal' ? 'selected' : ''}>Principal</option><option value="extra" ${item.category !== 'principal' ? 'selected' : ''}>Extra</option></select></td></tr>`).join('')}
                        </tbody></table></form>
                        <div class="p-6 sm:p-8 pt-4 mt-auto border-t border-slate-200 flex-shrink-0"><div class="grid grid-cols-2 gap-3"><button type="button" id="cancel-import-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 text-sm">Voltar</button><button type="button" id="confirm-import-btn" class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-700 text-sm">Importar Selecionados</button></div></div>`;
                    break;
                 case 'error':
                    contentHTML = `${header('Erro na Análise', 'Não foi possível processar a imagem.')}
                        <div class="p-6 sm:p-8 flex-1 flex flex-col items-center justify-center text-center"><i data-lucide="x-circle" class="w-12 h-12 text-red-500 mb-4"></i><p class="text-slate-500 mt-4 text-base">${data || 'Ocorreu um erro inesperado.'}</p><div class="mt-6"><button type="button" id="try-again-import-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-indigo-700 text-sm">Tentar Novamente</button></div></div>`;
                    break;
            }
            modalContent.innerHTML = contentHTML;
            App.attachImportModalListeners(view);
            lucide.createIcons();
        };

        App.attachImportModalListeners = (view) => {
             document.getElementById('close-import-modal-btn')?.addEventListener('click', App.closeAllModals);
             document.getElementById('cancel-import-btn')?.addEventListener('click', App.closeAllModals);
             document.getElementById('try-again-import-btn')?.addEventListener('click', () => App.openImageImportModal(App.state.currentImportType));

             switch(view) {
                case 'uploader':
                    document.getElementById('image-import-input').addEventListener('change', App.handleImageFileSelect);
                    document.getElementById('start-analysis-btn').addEventListener('click', App.processImageWithAI);
                    break;
                case 'verification':
                    document.getElementById('confirm-import-btn').addEventListener('click', App.handleImportApproval);
                    document.getElementById('select-all-scanned').addEventListener('change', (e) => {
                        document.querySelectorAll('input[name="scanned_item_check"]').forEach(checkbox => checkbox.checked = e.target.checked);
                    });
                    document.querySelectorAll('input[name="scanned_item_price"]').forEach(input => input.addEventListener('input', App.maskCurrency));
                    break;
             }
        };

        App.handleImageFileSelect = (event) => {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('image-preview').src = e.target.result;
                    App.state.importedImageData = e.target.result.split(',')[1];
                    document.getElementById('image-uploader-section').classList.add('hidden');
                    document.getElementById('image-preview-section').classList.remove('hidden');
                    document.getElementById('start-analysis-btn').disabled = false;
                };
                reader.readAsDataURL(file);
            } else {
                App.showToast("Por favor, selecione um ficheiro de imagem válido.", true);
                document.getElementById('start-analysis-btn').disabled = true;
            }
        };
        
        App.handleImportApproval = async () => {
            const rows = document.querySelectorAll('.scanned-item-row');
            const productsToInsert = [];
            rows.forEach(row => {
                if(row.querySelector('input[name="scanned_item_check"]').checked) {
                    const name = row.querySelector('input[name="scanned_item_name"]').value.trim();
                    const price = App.getNumericValue(row.querySelector('input[name="scanned_item_price"]').value);
                    const category = row.querySelector('select[name="scanned_item_category"]').value;
                    if(name && !isNaN(price) && price > 0) { productsToInsert.push({ name, price, category, user_id: App.state.currentUser.id }); }
                }
            });
            if(productsToInsert.length === 0) { App.showToast("Nenhum produto válido selecionado para importar.", true); return; }
            App.showLoading();
            const { error } = await db.from('products').insert(productsToInsert);
            if(error) { App.showToast(`Erro ao importar produtos: ${error.message}`, true); } 
            else { App.showToast(`${productsToInsert.length} produtos importados com sucesso!`); }
            await App.loadData(); App.closeAllModals(); App.navigateTo('products'); App.hideLoading();
        };
        
        App.openCashSessionModal = (type) => {
            const modal = document.getElementById('cash-session-modal');
            const modalContent = modal.querySelector('.modal-content');
            let contentHTML = '';
            if (type === 'open') {
                contentHTML = `<form id="open-caixa-form" class="p-6"><h3 class="text-base font-bold text-slate-800 mb-4">Abrir Caixa</h3><div><label for="valor_abertura" class="block text-xs font-medium text-slate-600">Valor Inicial (Troco)</label><input type="text" id="valor_abertura" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm" inputmode="decimal"></div><div class="grid grid-cols-2 gap-3 pt-6"><button type="button" id="cancel-modal-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 transition-colors text-sm">Cancelar</button><button type="submit" class="bg-indigo-600 text-white font-semibold py-2.5 rounded-lg text-sm">Abrir Caixa</button></div></form>`;
            } else {
                 const { activeCashSession } = App.state;
                 const ordersInSession = App.state.orders.filter(o => o.caixa_sessao_id === activeCashSession?.id && o.status !== 'Cancelado');
                 const totalDinheiro = ordersInSession.filter(o => o.payment_method === 'Dinheiro').reduce((sum, o) => sum + o.total_value, 0);
                 const valorEsperado = (activeCashSession?.valor_abertura || 0) + totalDinheiro;
                contentHTML = `<form id="close-caixa-form" class="p-6"><h3 class="text-base font-bold text-slate-800 mb-2">Fechar Caixa</h3><p class="text-xs text-slate-500 mb-4">Valor esperado em caixa: <strong class="text-slate-700">${App.formatCurrency(valorEsperado)}</strong></p><div><label for="valor_fechamento" class="block text-xs font-medium text-slate-600">Valor Contado no Caixa</label><input type="text" id="valor_fechamento" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm" inputmode="decimal"></div><div class="grid grid-cols-2 gap-3 pt-6"><button type="button" id="cancel-modal-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 transition-colors text-sm">Cancelar</button><button type="submit" class="bg-red-600 text-white font-semibold py-2.5 rounded-lg text-sm">Confirmar Fechamento</button></div></form>`;
            }
            modalContent.innerHTML = contentHTML;
            modal.classList.add('open');
            modalContent.classList.add('open');
            document.getElementById('valor_abertura')?.addEventListener('input', App.maskCurrency);
            document.getElementById('valor_fechamento')?.addEventListener('input', App.maskCurrency);
        };

        App.handleOpenCaixaSubmit = async (e) => {
            e.preventDefault();
            const valorAbertura = App.getNumericValue(document.getElementById('valor_abertura').value);
            if (isNaN(valorAbertura) || valorAbertura < 0) { App.showToast("Por favor, insira um valor de abertura válido.", true); return; }
            App.showLoading();
            const { data: { user } } = await db.auth.getUser();
            const { error } = await db.from('caixa_sessoes').insert({ valor_abertura: valorAbertura, user_id: user.id });
            if (error) { App.showToast(`Erro ao abrir caixa: ${error.message}`, true); } 
            else { App.showToast('Caixa aberto com sucesso!'); await App.loadData(); App.closeAllModals(); App.navigateTo('dashboard'); }
            App.hideLoading();
        };

        App.handleCloseCaixaSubmit = async (e) => {
            e.preventDefault();
            const valorFechamento = App.getNumericValue(document.getElementById('valor_fechamento').value);
            if (isNaN(valorFechamento) || valorFechamento < 0) { App.showToast("Por favor, insira um valor de fechamento válido.", true); return; }
            App.showLoading();
            const { activeCashSession } = App.state;
            const ordersInSession = App.state.orders.filter(o => o.caixa_sessao_id === activeCashSession.id && o.status !== 'Cancelado');
            const totalDinheiro = ordersInSession.filter(o => o.payment_method === 'Dinheiro').reduce((sum, o) => sum + o.total_value, 0);
            const { error } = await db.from('caixa_sessoes').update({ data_fechamento: new Date().toISOString(), valor_fechamento: valorFechamento, valor_apurado_dinheiro: totalDinheiro }).eq('id', activeCashSession.id);
            if (error) { App.showToast(`Erro ao fechar caixa: ${error.message}`, true); } 
            else { App.showToast('Caixa fechado com sucesso!'); await App.loadData(); App.closeAllModals(); App.navigateTo('dashboard'); }
            App.hideLoading();
        };

        App.handleAssignMotoboy = async (e) => {
            e.preventDefault();
            const orderId = Number(e.target.dataset.orderId);
            const motoboyId = Number(document.getElementById('motoboy-select').value);
            if (!motoboyId) { App.showToast("Selecione um motoboy.", true); return; }
            App.closeAllModals(); App.handleMarkAsDelivered(orderId, motoboyId);
        };
        
        App.renderPersonalIncomeCreationUI = () => {
            const modalContent = document.getElementById('personal-income-modal').querySelector('.modal-content');
            modalContent.innerHTML = `<div class="p-6 sm:p-8"><h2 class="text-xl font-bold text-slate-800 mb-6">Nova Receita Pessoal</h2><form id="modal-income-form" class="space-y-4"><div><label for="modal-income-description" class="block text-xs font-medium text-slate-600">Descrição</label><input type="text" id="modal-income-description" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div><div class="grid grid-cols-2 gap-4"><div><label for="modal-income-amount" class="block text-xs font-medium text-slate-600">Valor</label><input type="text" id="modal-income-amount" required class="mt-1 block w-full p-2.5 border rounded-lg text-sm" inputmode="decimal"></div><div><label for="modal-income-date" class="block text-xs font-medium text-slate-600">Data</label><input type="date" id="modal-income-date" required class="mt-1 block w-full p-2.5 border rounded-lg text-sm"></div></div><div class="grid grid-cols-2 gap-3 pt-4"><button type="button" id="cancel-modal-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 transition-colors text-sm">Cancelar</button><button type="submit" class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">Salvar Receita</button></div></form></div>`;
            document.getElementById('modal-income-date').valueAsDate = new Date();
            document.getElementById('modal-income-amount').addEventListener('input', App.maskCurrency);
        };

        App.renderExpenseCreationUI = (type) => {
            const modalContent = document.getElementById('expense-creation-modal').querySelector('.modal-content');
            modalContent.innerHTML = `<div class="p-6 sm:p-8"><h2 class="text-xl font-bold text-slate-800 mb-6 flex justify-between items-center"><span>Lançar Despesa ${type === 'pessoal' ? 'Pessoal' : 'da Empresa'}</span><button type="button" id="open-expense-importer-btn" class="p-2 rounded-full hover:bg-slate-200 transition-colors" title="Importar com IA"><i data-lucide="camera" class="w-5 h-5 text-slate-600"></i></button></h2><form id="modal-expense-form" data-type="${type}" class="space-y-4"><div><label for="modal-expense-description" class="block text-xs font-medium text-slate-600">Descrição</label><input type="text" id="modal-expense-description" required class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div><div class="grid grid-cols-2 gap-4"><div><label for="modal-expense-amount" class="block text-xs font-medium text-slate-600">Valor</label><input type="text" id="modal-expense-amount" required class="mt-1 block w-full p-2.5 border rounded-lg text-sm" inputmode="decimal"></div><div><label for="modal-expense-date" class="block text-xs font-medium text-slate-600">Data</label><input type="date" id="modal-expense-date" required class="mt-1 block w-full p-2.5 border rounded-lg text-sm"></div></div><div class="grid grid-cols-2 gap-3 pt-4"><button type="button" id="cancel-modal-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 transition-colors text-sm">Cancelar</button><button type="submit" class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">Salvar Despesa</button></div></form></div>`;
            lucide.createIcons();
            document.getElementById('modal-expense-date').valueAsDate = new Date();
            document.getElementById('modal-expense-amount').addEventListener('input', App.maskCurrency);
        };
        
        App.renderOrderCreationUI = () => {
            const orderModalContent = document.getElementById('order-creation-modal').querySelector('.modal-content');
            const { step } = App.state.currentOrder;
            
            if (step === 1) {
                orderModalContent.innerHTML = App.renderOrderStep1();
                App.attachStep1Listeners();
            } else {
                orderModalContent.innerHTML = App.renderOrderStep2();
                App.attachStep2Listeners();
            }
            lucide.createIcons();
        };

        App.renderOrderStep1 = () => {
            const { is_internal_consumption } = App.state.currentOrder;
            const isEditing = App.state.editingOrderId !== null;

            return `
                <div class="flex h-full">
                    <!-- Left Side: Product Selection -->
                    <div class="w-2/3 flex flex-col h-full bg-slate-50 rounded-l-xl">
                        <div class="p-6 sm:p-8 pb-4 flex-shrink-0">
                            <div class="flex justify-between items-start gap-4">
                                <h2 class="text-2xl font-bold text-slate-800 mb-2">${isEditing ? 'Editar Pedido' : 'Novo Pedido'} <span class="text-base font-normal text-slate-500">- Etapa 1 de 2</span></h2>
                                <div class="flex items-center gap-2 mt-2">
                                    <span class="text-xs font-semibold text-slate-500">Consumo Interno</span>
                                    <label for="internal-consumption-toggle" class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="internal-consumption-toggle" class="sr-only toggle-checkbox" ${is_internal_consumption ? 'checked' : ''}>
                                        <div class="toggle-label w-11 h-6 bg-slate-200 rounded-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-transform"></div>
                                    </label>
                                </div>
                            </div>
                            <p class="text-sm text-slate-500">Selecione os produtos e adicione-os ao pedido.</p>
                        </div>
                        <div class="flex-1 px-6 sm:px-8 py-4 space-y-4 overflow-y-auto">
                            <div id="product-card-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                               <!-- Product cards are rendered here by JS -->
                            </div>
                        </div>
                    </div>
                    <!-- Right Side: Order Summary & Actions -->
                    <div class="w-1/3 bg-white border-l border-slate-200 flex flex-col rounded-r-xl">
                        <div class="p-6 sm:p-8 pb-4 flex-shrink-0">
                            <h3 class="font-semibold text-lg text-slate-800">Resumo do Pedido</h3>
                        </div>
                        <div id="current-order-items-list-container" class="flex-1 overflow-y-auto px-6 sm:px-8">
                            <!-- Items will be rendered here -->
                        </div>
                        <div class="p-6 sm:p-8 pt-4 flex-shrink-0 border-t border-slate-200">
                           <p class="flex justify-between items-center mb-4"><span>Total:</span> <span id="order-total" class="text-2xl font-bold text-slate-800">R$ 0,00</span></p>
                           <div class="grid grid-cols-2 gap-3">
                               <button type="button" id="cancel-order-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 transition-colors text-sm">Cancelar</button>
                               <button type="button" id="next-step-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-indigo-700 transition-colors text-sm flex items-center justify-center gap-2"><span>Próximo</span> <i data-lucide="arrow-right" class="w-4 h-4"></i></button>
                           </div>
                        </div>
                    </div>
                </div>
            `;
        };

        App.renderOrderStep2 = () => {
            const isEditing = App.state.editingOrderId !== null;
            return `
                <div class="flex h-full">
                    <!-- Left Side: Order Summary -->
                    <div class="w-1/3 flex flex-col h-full bg-slate-100 rounded-l-xl border-r border-slate-200">
                         <div class="p-6 sm:p-8 pb-4 flex-shrink-0">
                            <h2 class="text-2xl font-bold text-slate-800 mb-2">${isEditing ? 'Editar Pedido' : 'Novo Pedido'} <span class="text-base font-normal text-slate-500">- Etapa 2 de 2</span></h2>
                            <p class="text-sm text-slate-500">Confirme os detalhes finais para concluir.</p>
                        </div>
                        <div id="current-order-items-list-container" class="flex-1 overflow-y-auto px-6 sm:px-8">
                            <!-- Items will be rendered here -->
                        </div>
                        <div class="p-6 sm:p-8 pt-4 flex-shrink-0 border-t border-slate-200">
                           <p class="flex justify-between items-center"><span>Total:</span> <span id="order-total" class="text-2xl font-bold text-slate-800">R$ 0,00</span></p>
                        </div>
                    </div>
                    <!-- Right Side: Final Details & Actions -->
                    <form id="finalize-order-form" class="w-2/3 bg-white flex flex-col rounded-r-xl">
                       <div class="p-6 sm:p-8 flex-1 flex flex-col">
                           <h3 class="font-semibold text-lg mb-4 text-slate-800">Detalhes Finais</h3>
                           <div class="flex-grow overflow-y-auto pr-4 space-y-4">
                                <div id="customer-area">
                                    <div id="customer-selection-area"><label for="order-customer-select" class="block text-xs font-medium text-slate-600">Cliente</label><div class="flex items-center gap-2 mt-1"><select id="order-customer-select" required class="flex-grow p-2.5 border border-slate-300 rounded-lg bg-white text-sm"><option value="">Selecione...</option>${App.state.customers.map(c => `<option value="${c.id}" ${App.state.currentOrder.customer_id == c.id ? 'selected' : ''}>${c.name}</option>`).join('')}</select><button id="add-customer-from-modal-btn" type="button" class="p-2.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors" title="Adicionar Novo Cliente"><i data-lucide="plus" class="w-5 h-5"></i></button></div></div>
                                    <div id="new-customer-form-area" class="hidden space-y-3 border border-slate-200 p-4 rounded-lg mt-2">
                                        <h4 class="font-semibold text-slate-800 text-sm">Novo Cliente</h4>
                                        <div><label for="modal-customer-name" class="block text-xs font-medium text-slate-600">Nome</label><input type="text" id="modal-customer-name" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div>
                                        <div><label for="modal-customer-phone" class="block text-xs font-medium text-slate-600">Contato</label><input type="tel" id="modal-customer-phone" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div>
                                        <div><label for="modal-customer-address" class="block text-xs font-medium text-slate-600">Endereço</label><input type="text" id="modal-customer-address" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div>
                                        <div class="grid grid-cols-2 gap-4">
                                            <div><label for="modal-customer-number" class="block text-xs font-medium text-slate-600">Número</label><input type="text" id="modal-customer-number" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div>
                                            <div><label for="modal-customer-neighborhood" class="block text-xs font-medium text-slate-600">Bairro</label><input type="text" id="modal-customer-neighborhood" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div>
                                        </div>
                                        <div><label for="modal-customer-complement" class="block text-xs font-medium text-slate-600">Complemento</label><input type="text" id="modal-customer-complement" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"></div>
                                        <div class="flex gap-2 justify-end"><button type="button" id="cancel-add-customer-btn" class="text-xs font-semibold text-slate-600 py-2 px-3 rounded-lg hover:bg-slate-100">Cancelar</button><button type="button" id="save-customer-from-modal-btn" class="text-xs font-semibold text-white bg-indigo-600 py-2 px-3 rounded-lg hover:bg-indigo-700">Salvar Cliente</button></div>
                                    </div>
                                    <div id="customer-history-area" class="mt-2 space-y-1 hidden"></div>
                                </div>
                                <div id="delivery-details" class="grid grid-cols-2 gap-4 items-end"><div><label class="block text-xs font-medium text-slate-600 mb-2">Tipo</label><div class="flex items-center justify-center bg-slate-200 rounded-lg p-1 gap-1 h-[42px]"><span class="text-xs font-semibold" id="order-type-label-pickup">Retirada</span><div class="relative"><input type="checkbox" id="order-type-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer hidden" ${App.state.currentOrder.is_delivery ? 'checked' : ''}><label for="order-type-toggle" class="toggle-label block w-10 h-6 rounded-full bg-slate-300 cursor-pointer transition-colors relative after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-transform after:duration-300 ease-in-out"></label></div><span class="text-xs font-semibold" id="order-type-label-delivery">Entrega</span></div></div><div id="delivery-cost-container" class="${App.state.currentOrder.is_delivery ? '' : 'hidden'}"><label for="delivery-cost" class="block text-xs font-medium text-slate-600">Custo da Entrega</label><input type="text" id="delivery-cost" value="${App.formatCurrency(App.state.currentOrder.delivery_cost)}" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm" inputmode="decimal"></div></div>
                                <div><label for="order-payment-method" class="block text-xs font-medium text-slate-600">Pagamento</label><select id="order-payment-method" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm"><option ${App.state.currentOrder.payment_method === 'Dinheiro' ? 'selected' : ''}>Dinheiro</option><option ${App.state.currentOrder.payment_method === 'Cartão' ? 'selected' : ''}>Cartão</option><option ${App.state.currentOrder.payment_method === 'Pix' ? 'selected' : ''}>Pix</option></select></div>
                                <div id="change-calculation-area" class="hidden">
                                    <div class="grid grid-cols-2 gap-4 items-center">
                                        <div><label for="order-amount-received" class="block text-xs font-medium text-slate-600">Valor Recebido</label><input type="text" id="order-amount-received" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm" inputmode="decimal"></div>
                                        <div class="text-right"><label class="block text-xs font-medium text-slate-600">Troco</label><p id="order-change-due" class="mt-1 text-lg font-bold text-slate-800">R$ 0,00</p></div>
                                    </div>
                                </div>
                                <div><label for="order-notes" class="block text-xs font-medium text-slate-600">Observações</label><input type="text" id="order-notes" value="${App.state.currentOrder.notes}" class="mt-1 block w-full p-2.5 border border-slate-300 rounded-lg text-sm" placeholder="Ex: sem cebola, ponto da carne..."></div>
                           </div>
                           <div class="mt-auto pt-6 border-t border-slate-200">
                               <div class="flex gap-3">
                                   <button type="button" id="prev-step-btn" class="w-full bg-slate-200 text-slate-800 font-semibold py-2.5 px-4 rounded-lg hover:bg-slate-300 transition-colors text-sm flex items-center justify-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4"></i> <span>Voltar</span></button>
                                   <button type="submit" class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm">Finalizar Pedido</button>
                               </div>
                           </div>
                       </div>
                    </form>
                </div>
            `;
        };

        App.renderProductCards = () => {
            const grid = document.getElementById('product-card-grid');
            if(!grid) return;
            const products = App.state.products.filter(p => p.is_active !== false);
            if(products.length === 0) {
                grid.innerHTML = `<p class="col-span-full text-slate-500 text-center py-8 text-sm">Nenhum produto ativo. Vá à página 'Produtos' para adicionar ou reativar.</p>`;
                return;
            }
            grid.innerHTML = products.map(product => `
                <div class="product-card bg-white border border-slate-200 rounded-xl p-3 text-center flex flex-col transition-all duration-200 hover:shadow-lg hover:ring-2 hover:ring-indigo-500">
                    <img src="${product.image_url || 'https://placehold.co/150x100/e0e7ff/4f46e5?text=Produto'}" alt="${product.name}" class="w-full h-24 object-cover rounded-lg mb-2 bg-slate-100" onerror="this.onerror=null;this.src='https://placehold.co/150x100/e0e7ff/4f46e5?text=Erro';">
                    <h5 class="font-semibold text-sm text-slate-800 flex-1 leading-tight">${product.name}</h5>
                    <p class="text-xs text-slate-500 mt-1">${App.formatCurrency(product.price)}</p>
                    <div class="mt-3">
                        <div class="flex items-center justify-center gap-2">
                            <button data-product-id="${product.id}" class="decrease-qty-btn bg-slate-200 text-slate-700 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="minus" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                            <span class="product-card-qty font-bold text-lg text-slate-900 w-8 text-center" data-product-id="${product.id}">1</span>
                            <button data-product-id="${product.id}" class="increase-qty-btn bg-slate-200 text-slate-700 rounded-md w-7 h-7 flex items-center justify-center hover:bg-slate-300 transition-colors">
                                <i data-lucide="plus" class="w-4 h-4 pointer-events-none"></i>
                            </button>
                        </div>
                        <button data-product-id="${product.id}" class="add-item-from-card-btn bg-indigo-100 text-indigo-700 font-semibold text-xs py-1.5 px-3 rounded-lg mt-2 w-full hover:bg-indigo-200 transition-colors">Adicionar</button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        };
        
        App.attachStep1Listeners = () => {
            App.renderProductCards();
            App.renderCurrentOrderItems();
        
            const internalToggle = document.getElementById('internal-consumption-toggle');
            internalToggle?.addEventListener('change', () => {
                App.state.currentOrder.is_internal_consumption = internalToggle.checked;
                App.renderCurrentOrderItems();
            });

            document.getElementById('cancel-order-btn')?.addEventListener('click', App.closeAllModals);
            document.getElementById('next-step-btn')?.addEventListener('click', () => {
                if (App.state.currentOrder.items.length === 0) {
                    App.showToast("Adicione pelo menos um item ao pedido para continuar.", true);
                    return;
                }
                App.state.currentOrder.step = 2;
                App.renderOrderCreationUI();
            });
        };

        App.attachStep2Listeners = () => {
            App.renderCurrentOrderItems();
            
            document.getElementById('add-customer-from-modal-btn')?.addEventListener('click', () => {
                document.getElementById('customer-selection-area').classList.add('hidden');
                document.getElementById('new-customer-form-area').classList.remove('hidden');
            });
            document.getElementById('cancel-add-customer-btn')?.addEventListener('click', () => {
                document.getElementById('new-customer-form-area').classList.add('hidden');
                document.getElementById('customer-selection-area').classList.remove('hidden');
            });
            document.getElementById('save-customer-from-modal-btn')?.addEventListener('click', App.handleSaveNewCustomerFromModal);
            
            document.getElementById('order-customer-select')?.addEventListener('change', (e) => {
                const customerId = e.target.value ? Number(e.target.value) : null;
                App.state.currentOrder.customer_id = customerId;
                App.renderCustomerHistory(customerId);
                App.autofillDeliveryCost(customerId);
            });

            const typeToggle = document.getElementById('order-type-toggle');
            typeToggle?.addEventListener('change', () => {
                App.state.currentOrder.is_delivery = typeToggle.checked;
                document.getElementById('delivery-cost-container').classList.toggle('hidden', !typeToggle.checked);
                if (!typeToggle.checked) { 
                    App.state.currentOrder.delivery_cost = 0;
                    document.getElementById('delivery-cost').value = App.formatCurrency(0); 
                }
                App.updateOrderTotal();
            });
            document.getElementById('delivery-cost')?.addEventListener('input', (e) => { 
                App.maskCurrency(e); 
                App.state.currentOrder.delivery_cost = App.getNumericValue(e.target.value);
                App.updateOrderTotal(); 
            });
            
            const paymentMethodSelect = document.getElementById('order-payment-method');
            paymentMethodSelect?.addEventListener('change', (e) => {
                App.state.currentOrder.payment_method = e.target.value;
                App.updatePaymentDetailsVisibility();
            });
            
            const amountReceivedInput = document.getElementById('order-amount-received');
            amountReceivedInput?.addEventListener('input', (e) => {
                App.maskCurrency(e);
                App.updateChange();
            });

            document.getElementById('order-notes')?.addEventListener('input', (e) => {
                App.state.currentOrder.notes = e.target.value;
            });

            document.getElementById('prev-step-btn')?.addEventListener('click', () => {
                App.state.currentOrder.step = 1;
                App.renderOrderCreationUI();
            });

            App.updatePaymentDetailsVisibility();
            App.renderCustomerHistory(App.state.currentOrder.customer_id);
        };

        App.handleAddItemFromCard = (productId) => {
            const product = App.state.products.find(p => p.id === productId);
            const qtySpan = document.querySelector(`.product-card-qty[data-product-id="${productId}"]`);
            const quantity = parseInt(qtySpan.textContent, 10);
            
            if(!product || !quantity) return;
            
            const existingItem = App.state.currentOrder.items.find(item => item.product_id === product.id);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                 App.state.currentOrder.items.push({
                    product_id: product.id, name: product.name, quantity: quantity, price: product.price
                });
            }

            App.renderCurrentOrderItems();
            App.showToast(`${quantity}x ${product.name} adicionado(s).`);
            qtySpan.textContent = '1'; // Reset quantity on card
        };
        
        App.renderCustomerHistory = (customerId) => {
            const container = document.getElementById('customer-history-area');
            if (!container || !customerId) { if(container) { container.innerHTML = ''; container.classList.add('hidden'); } return; }
            const customerOrders = App.state.orders.filter(o => o.customer_id === customerId && !o.is_internal_consumption).slice(0, 3);
            if (customerOrders.length === 0) { container.innerHTML = ''; container.classList.add('hidden'); return; }
            container.classList.remove('hidden');
            container.innerHTML = `<h4 class="text-xs font-semibold text-slate-600 mb-1">Últimos Pedidos</h4><ul class="space-y-1 text-xs text-slate-500">${customerOrders.map(order => { const items = App.state.orderItems.filter(item => item.order_id === order.id); return `<li class="p-2 bg-slate-50 rounded-md">${items.map(i => `${i.quantity}x ${i.products?.name || 'Produto'}`).join(', ')} - ${App.formatCurrency(order.total_value)}</li>`}).join('')}</ul>`;
        };
        
        App.autofillDeliveryCost = (customerId) => {
            const deliveryCostInput = document.getElementById('delivery-cost');
            if (!deliveryCostInput || !customerId) return;
            const lastDeliveryOrder = App.state.orders.find(o => o.customer_id === customerId && o.is_delivery && o.delivery_cost > 0);
            if (lastDeliveryOrder) {
                App.state.currentOrder.delivery_cost = lastDeliveryOrder.delivery_cost;
                deliveryCostInput.value = App.formatCurrency(lastDeliveryOrder.delivery_cost);
                App.updateOrderTotal();
            }
        };

        App.handleSaveNewCustomerFromModal = async () => {
            const name = document.getElementById('modal-customer-name').value.trim();
            const phone = document.getElementById('modal-customer-phone').value.trim();
            const address = document.getElementById('modal-customer-address').value.trim();
            const numero = document.getElementById('modal-customer-number').value.trim();
            const bairro = document.getElementById('modal-customer-neighborhood').value.trim();
            const complemento = document.getElementById('modal-customer-complement').value.trim();
            if (!name) { App.showToast("O nome do cliente é obrigatório.", true); return; }
            App.showLoading();
            const { data, error } = await db.from('customers').insert({ name, phone, address, numero, bairro, complemento, user_id: App.state.currentUser.id }).select().single();
            if (error) { App.showToast(`Erro ao salvar cliente: ${error.message}`, true); App.hideLoading(); return; }
            await App.loadData();
            App.state.currentOrder.customer_id = data.id;

            const customerSelect = document.getElementById('order-customer-select');
            customerSelect.innerHTML = `<option value="">Selecione...</option>` + App.state.customers.map(c => `<option value="${c.id}" ${c.id === data.id ? 'selected' : ''}>${c.name}</option>`).join('');
            
            document.getElementById('new-customer-form-area').classList.add('hidden');
            document.getElementById('customer-selection-area').classList.remove('hidden');
            
            App.showToast("Novo cliente salvo com sucesso!"); App.hideLoading();
        };
        
        App.renderCurrentOrderItems = () => { 
            const container = document.getElementById('current-order-items-list-container'); 
            if (!container) return; 
            if(App.state.currentOrder.items.length === 0){ 
                container.innerHTML = `<p class="text-slate-500 text-center py-4 text-sm">Nenhum item adicionado.</p>`; 
            } else { 
                const isStep1 = App.state.currentOrder.step === 1;
                container.innerHTML = `<ul class="divide-y divide-slate-100 text-sm">${App.state.currentOrder.items.map((item, index) => `<li class="py-2 flex justify-between items-center"><div><p class="font-medium">${item.name}</p><p class="text-xs text-slate-500">${item.quantity} x ${App.state.currentOrder.is_internal_consumption ? App.formatCurrency(0) : App.formatCurrency(item.price)}</p></div><div class="flex items-center gap-2"><span class="font-semibold text-slate-800">${App.state.currentOrder.is_internal_consumption ? App.formatCurrency(0) : App.formatCurrency(item.price * item.quantity)}</span>${isStep1 ? `<button data-index="${index}" class="delete-order-item-btn p-1.5 text-slate-500 hover:text-red-600 rounded-md transition-colors" title="Remover item"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>` : ''}</div></li>`).join('')}</ul>`; 
            } 
            App.updateOrderTotal(); 
            lucide.createIcons(); 
        };
        
        App.removeItemFromOrder = (index) => { App.state.currentOrder.items.splice(index, 1); App.renderCurrentOrderItems(); };
        
        App.updateOrderTotal = () => {
            const totalEl = document.getElementById('order-total');
            if (!totalEl) return;
            if (App.state.currentOrder.is_internal_consumption) { App.state.currentOrder.total = 0; totalEl.textContent = App.formatCurrency(0); return; }
            
            const itemsTotal = App.state.currentOrder.items.reduce((sum, item) => sum + item.price * item.quantity, 0);
            const deliveryCost = App.state.currentOrder.delivery_cost || 0;
            const total = itemsTotal + deliveryCost;
            App.state.currentOrder.total = total;
            totalEl.textContent = App.formatCurrency(total);
            
            // Also update the total in step 2 if it's rendered
            const totalElStep2 = document.querySelector('#order-creation-modal #order-total');
            if(totalElStep2) totalElStep2.textContent = App.formatCurrency(total);

            App.updateChange();
        };

        App.updatePaymentDetailsVisibility = () => {
            const paymentMethod = document.getElementById('order-payment-method')?.value;
            const changeArea = document.getElementById('change-calculation-area');
            if (!changeArea) return;

            if (paymentMethod === 'Dinheiro') {
                changeArea.classList.remove('hidden');
            } else {
                changeArea.classList.add('hidden');
                const amountReceivedInput = document.getElementById('order-amount-received');
                if (amountReceivedInput) amountReceivedInput.value = '';
                App.updateChange(); // Reset change display
            }
        };

        App.updateChange = () => {
            const changeDueEl = document.getElementById('order-change-due');
            if (!changeDueEl) return;

            const amountReceivedInput = document.getElementById('order-amount-received');
            const receivedAmount = App.getNumericValue(amountReceivedInput?.value || '0');
            const total = App.state.currentOrder.total || 0;

            if (receivedAmount === 0) {
                changeDueEl.textContent = App.formatCurrency(0);
                changeDueEl.classList.remove('text-red-600', 'text-green-600');
                return;
            }

            const change = receivedAmount - total;
            changeDueEl.textContent = App.formatCurrency(change);

            if (change < 0) {
                changeDueEl.classList.add('text-red-600');
                changeDueEl.classList.remove('text-green-600');
            } else {
                changeDueEl.classList.remove('text-red-600');
                changeDueEl.classList.add('text-green-600');
            }
        };

        App.handleFinalizeOrderSubmit = async (e) => {
            e.preventDefault();
            const isEditing = App.state.editingOrderId !== null;
            const { activeCashSession } = App.state;
            if (!activeCashSession && !isEditing) { App.showToast("O caixa está fechado. Abra o caixa para lançar um novo pedido.", true); return; }

            const { customer_id, items, total, payment_method, is_delivery, notes, delivery_cost, is_internal_consumption } = App.state.currentOrder;
            if (!customer_id && !is_internal_consumption) { App.showToast("Selecione um cliente.", true); return; }
            if (items.length === 0) { App.showToast("Adicione pelo menos um item ao pedido.", true); return; }
            App.showLoading();
            const orderData = { user_id: App.state.currentUser.id, customer_id: is_internal_consumption ? null : customer_id, total_value: is_internal_consumption ? 0 : total, payment_method: is_internal_consumption ? null : payment_method, status: is_internal_consumption ? 'Entregue' : 'Pendente', is_delivery: is_internal_consumption ? false : is_delivery, notes, delivery_cost: is_internal_consumption ? 0 : delivery_cost, is_internal_consumption: is_internal_consumption, caixa_sessao_id: isEditing ? (App.state.orders.find(o => o.id === App.state.editingOrderId)?.caixa_sessao_id || activeCashSession?.id) : activeCashSession?.id };
            
            if (isEditing) {
                const { error: orderError } = await db.from('orders').update(orderData).eq('id', App.state.editingOrderId);
                if (orderError) { App.showToast(`Erro ao atualizar pedido: ${orderError.message}`, true); App.hideLoading(); return; }
                const { error: deleteError } = await db.from('order_items').delete().eq('order_id', App.state.editingOrderId);
                if (deleteError) { App.showToast(`Erro ao limpar itens antigos: ${deleteError.message}`, true); App.hideLoading(); return; }
                const orderItemsData = items.map(item => ({ order_id: App.state.editingOrderId, product_id: item.product_id, quantity: item.quantity, unit_price: item.price }));
                const { error: itemsError } = await db.from('order_items').insert(orderItemsData);
                if (itemsError) { App.showToast(`Erro ao atualizar itens: ${itemsError.message}`, true); App.hideLoading(); return; }
                App.showToast("Pedido atualizado com sucesso!");
            } else {
                const { data: newOrder, error: orderError } = await db.from('orders').insert(orderData).select().single();
                if (orderError) { App.showToast(orderError.message, true); App.hideLoading(); return; }
                const orderItemsData = items.map(item => ({ order_id: newOrder.id, product_id: item.product_id, quantity: item.quantity, unit_price: item.price }));
                const { error: itemsError } = await db.from('order_items').insert(orderItemsData);
                if (itemsError) { App.showToast(itemsError.message, true); App.hideLoading(); return; }
                App.showToast(is_internal_consumption ? "Consumo interno registado!" : "Pedido lançado com sucesso!");
            }
            await App.loadData(); App.closeAllModals(); App.navigateTo('dashboard'); App.hideLoading();
        };

        // ========== LÓGICA DE IA (GEMINI) ==========
        App.callGeminiAPI = async (payload) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorBody = await response.json(); console.error("Erro na API Gemini:", errorBody); throw new Error(`A API retornou um erro: ${errorBody.error?.message || response.statusText}`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]) { return result.candidates[0].content.parts[0].text; } 
                else { console.error("Resposta da API Gemini inválida:", result); throw new Error("Não foi possível extrair conteúdo da resposta da IA."); }
            } catch (error) { console.error("Falha ao chamar a API Gemini:", error); App.showToast(`Erro de comunicação com a IA: ${error.message}`, true); return null; }
        };

        App.generateImageWithAI = async () => {
             const productName = document.getElementById('product-name').value.trim();
             if(!productName) {
                 App.showToast('Por favor, insira um nome para o produto primeiro.', true);
                 return;
             }
             
             const previewContainer = document.getElementById('product-image-preview-container');
             if(!previewContainer) {
                 console.error("Image preview container not found.");
                 return;
             }

             const previewImg = previewContainer.querySelector('img');
             const placeholder = previewContainer.querySelector('i') || previewContainer.querySelector('svg');
             const loader = previewContainer.querySelector('.loader');

             if(!previewImg || !placeholder || !loader) {
                 console.error("One or more elements inside the preview container are missing.");
                 return;
             }
             
             previewImg.classList.add('hidden');
             if(placeholder) placeholder.classList.add('hidden');
             loader.classList.remove('hidden');

             const payload = { instances: [{ prompt: `Fotografia de um prato de comida profissional e realista: ${productName}, em um prato branco, com fundo de madeira rústica, luz natural` }], parameters: { "sampleCount": 1} };
             const apiKey = ""; 
             const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
             try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if(!response.ok) throw new Error(`API de Imagem falhou com status: ${response.status}`);
                const result = await response.json();
                if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                    const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                    previewImg.src = imageUrl;
                    previewImg.classList.remove('hidden');
                    const blob = await (await fetch(imageUrl)).blob();
                    App.state.productFormImageFile = new File([blob], `${productName.replace(/\s+/g, '_')}_ai.png`, { type: 'image/png' });

                } else {
                    throw new Error("Resposta da API de imagem inválida.");
                }
             } catch(error) {
                 console.error("Erro ao gerar imagem com IA:", error);
                 App.showToast("Falha ao gerar a imagem. Tente novamente.", true);
                 if(placeholder) placeholder.classList.remove('hidden');
             } finally {
                 loader.classList.add('hidden');
             }
        };

        App.processImageWithAI = async () => {
            if (!App.state.importedImageData) { App.showToast("Nenhuma imagem selecionada para importar.", true); return; }
            App.renderImageImportUI('processing');
            let prompt = ''; let responseSchema;
            if (App.state.currentImportType === 'products') {
                prompt = "A partir da imagem deste cardápio, extraia os nomes dos produtos e os seus respetivos preços. Ignore itens que não pareçam ser produtos vendáveis. Se um preço não for claro, defina-o como 0.";
                responseSchema = { type: "ARRAY", items: { type: "OBJECT", properties: { "name": { "type": "STRING" }, "price": { "type": "NUMBER" } }, required: ["name", "price"] } };
            } else {
                prompt = `A partir da imagem deste recibo ou nota fiscal, extraia o nome do estabelecimento (ou uma descrição geral da despesa), o valor total da despesa e a data. Se a data não estiver presente, use a data de hoje: ${new Date().toLocaleDateString('pt-BR')}.`;
                responseSchema = { type: "OBJECT", properties: { "description": { "type": "STRING" }, "amount": { "type": "NUMBER" }, "date": { "type": "STRING", "description": "Formato AAAA-MM-DD" } }, required: ["description", "amount", "date"] };
            }
            const payload = { contents: [{ parts: [ { text: prompt }, { inline_data: { mime_type: "image/png", data: App.state.importedImageData } } ] }], generationConfig: { responseMimeType: "application/json", responseSchema: responseSchema } };
            const jsonResponse = await App.callGeminiAPI(payload);
            if (!jsonResponse) { App.renderImageImportUI('error', 'A IA não conseguiu responder. Tente novamente.'); return; }
            try {
                const data = JSON.parse(jsonResponse);
                if (App.state.currentImportType === 'products') {
                    if (Array.isArray(data) && data.length > 0) { App.state.scannedProducts = data; App.renderImageImportUI('verification', data); } 
                    else { App.renderImageImportUI('error', 'Nenhum produto encontrado na imagem. Tente com uma imagem mais clara.'); }
                } else {
                    App.closeAllModals();
                    const expenseType = App.state.viewMode === 'pessoal' ? 'pessoal' : 'empresa';
                    App.openExpenseModal(expenseType);
                    await new Promise(resolve => setTimeout(resolve, 100));
                    document.getElementById('modal-expense-description').value = data.description || '';
                    document.getElementById('modal-expense-amount').value = App.formatCurrency(data.amount || 0);
                    document.getElementById('modal-expense-date').value = data.date || new Date().toISOString().slice(0, 10);
                    App.showToast("Dados da despesa preenchidos pela IA! Verifique e salve.");
                }
            } catch(e) { console.error("Erro ao analisar JSON da IA:", e); App.renderImageImportUI('error', 'A IA retornou um formato inesperado.'); }
        };

        // ========== LÓGICA DO CHAT DE SUPORTE (SOMIA) ==========
        App.toggleChat = (forceOpen = false) => {
            App.state.isChatOpen = forceOpen ? true : !App.state.isChatOpen;
            if (App.state.isChatOpen) {
                supportChatPopup.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                if(App.state.chatHistory.length === 0) { App.addMessageToChat("Olá! Eu sou a Somia, sua assistente virtual. Como posso ajudar?", "somia"); }
            } else {
                supportChatPopup.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            }
        };

        App.addMessageToChat = (text, sender) => {
            const messageEl = document.createElement('div');
            messageEl.className = `max-w-[85%] rounded-xl p-3 text-sm flex items-start gap-2.5 chat-message-${sender}`;
            if (sender === 'somia') { messageEl.innerHTML = `<div class="w-7 h-7 rounded-full bg-indigo-500 text-white flex items-center justify-center flex-shrink-0"><i data-lucide="bot" class="w-4 h-4"></i></div><p class="text-slate-700">${text}</p>`; } 
            else { messageEl.innerHTML = `<p class="text-slate-800">${text}</p>`; }
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            lucide.createIcons();
        };

        App.handleChatSubmit = async (e) => {
            e.preventDefault();
            const userInput = chatInput.value.trim();
            if(!userInput) return;
            App.addMessageToChat(userInput, 'user');
            App.state.chatHistory.push({ role: "user", parts: [{ text: userInput }] });
            chatInput.value = '';
            typingIndicator.classList.remove('hidden');
            const systemInstruction = `Você é a Somia, uma assistente virtual amigável e prestativa para o aplicativo 'Somai'. O seu objetivo é ajudar o utilizador a usar o aplicativo. Use os dados de estado atuais do aplicativo para dar respostas relevantes. Estado atual: ${JSON.stringify({view: App.state.viewMode, customerCount: App.state.customers.length, productCount: App.state.products.length, pendingOrders: App.state.orders.filter(o => o.status === 'Pendente').length})}.`;
            const payload = { contents: [ ...App.state.chatHistory ], systemInstruction: { parts: [{ text: systemInstruction }] } };
            const aiResponse = await App.callGeminiAPI(payload);
            typingIndicator.classList.add('hidden');
            if(aiResponse) { App.addMessageToChat(aiResponse, 'somia'); App.state.chatHistory.push({ role: "model", parts: [{ text: aiResponse }] }); } 
            else { App.addMessageToChat("Desculpe, não consegui processar a sua pergunta. Pode tentar de novo?", 'somia'); }
        };

        // --- Avatar Modal Logic ---
        App.openAvatarModal = async () => {
            const modal = document.getElementById('avatar-selection-modal');
            modal.classList.add('open');
            modal.querySelector('.modal-content').classList.add('open');
            
            const grid = document.getElementById('avatar-options-grid');
            grid.innerHTML = '<div class="col-span-4 flex justify-center"><div class="loader"></div></div>';

            const { data: files, error } = await db.storage.from('icones').list('avatares', { limit: 100 });

            if (error) {
                grid.innerHTML = '<p class="col-span-4 text-center text-red-500">Erro ao carregar avatares.</p>';
                return;
            }

            const avatarFiles = files.filter(file => file.name.startsWith('Ellipse') && file.name.endsWith('.png'));
            grid.innerHTML = ''; // Clear loader
            
            avatarFiles.forEach(file => {
                const { data: { publicUrl } } = db.storage.from('icones').getPublicUrl(`avatares/${file.name}`);
                const button = document.createElement('button');
                button.className = 'avatar-option p-2 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500';
                button.dataset.filename = file.name;
                button.innerHTML = `<img src="${publicUrl}" alt="${file.name}" class="w-24 h-24 rounded-full object-cover">`;
                grid.appendChild(button);
            });
            
            document.getElementById('close-avatar-modal-btn').onclick = App.closeAllModals;
        };

        App.handleAvatarSelection = async (filename) => {
            App.showLoading();
            const { data, error } = await db.auth.updateUser({
                data: { avatar_url: filename }
            });
        
            if (error) {
                App.showToast(`Erro ao atualizar avatar: ${error.message}`, true);
            } else {
                App.showToast('Avatar atualizado com sucesso!');
                App.updateUserInfo(data.user);
            }
        
            App.hideLoading();
            App.closeAllModals();
        };

        
        // EVENT LISTENERS GLOBAIS
        document.body.addEventListener('click', (e) => {
            const target = e.target;
            const button = target.closest('button');
            const link = target.closest('a.nav-link');
            const profile = target.closest('#user-profile');

            if (profile) {
                App.openAvatarModal();
            }
            
            if (button) {
                const id = Number(button.dataset.id);
                const index = Number(button.dataset.index);
                const value = button.dataset.value;
                const productId = Number(button.dataset.productId);
                const avatarFilename = button.dataset.filename;

                if(avatarFilename) {
                    App.handleAvatarSelection(avatarFilename);
                }

                if (button.classList.contains('pagination-btn')) {
                    const list = button.dataset.list;
                    const action = button.dataset.action;

                    if (list === 'session-orders') {
                        if (action === 'next') App.state.sessionOrdersCurrentPage++;
                        if (action === 'prev') App.state.sessionOrdersCurrentPage--;
                        const ordersInSession = App.state.orders.filter(o => o.caixa_sessao_id === App.state.activeCashSession.id && o.status !== 'Cancelado');
                        App.renderSessionOrdersListContainer(ordersInSession);
                    }
                } else if (button.classList.contains('increase-qty-btn')) {
                    const card = button.closest('.product-card');
                    if (card) {
                        const qtySpan = card.querySelector('.product-card-qty');
                        let currentQty = parseInt(qtySpan.textContent, 10);
                        qtySpan.textContent = currentQty + 1;
                    }
                } else if (button.classList.contains('decrease-qty-btn')) {
                    const card = button.closest('.product-card');
                    if (card) {
                        const qtySpan = card.querySelector('.product-card-qty');
                        let currentQty = parseInt(qtySpan.textContent, 10);
                        if (currentQty > 1) {
                            qtySpan.textContent = currentQty - 1;
                        }
                    }
                } else if (button.classList.contains('add-item-from-card-btn')) {
                    App.handleAddItemFromCard(Number(button.dataset.productId));
                } else if (button.classList.contains('delete-order-item-btn')) {
                    App.removeItemFromOrder(index);
                } else if (button.classList.contains('edit-customer-btn')) {
                    App.editCustomer(id);
                } else if (button.classList.contains('delete-customer-btn')) {
                    App.deleteCustomer(id);
                } else if (button.classList.contains('edit-product-btn')) {
                    App.editProduct(id);
                } else if (button.classList.contains('deactivate-product-btn')) {
                    App.deactivateProduct(id);
                } else if (button.classList.contains('activate-product-btn')) {
                    App.activateProduct(id);
                } else if (button.classList.contains('edit-ingredient-btn')) {
                    App.editIngredient(id);
                } else if (button.classList.contains('delete-ingredient-btn')) {
                    App.deleteIngredient(id);
                } else if (button.classList.contains('edit-motoboy-btn')) {
                    App.editMotoboy(id);
                } else if (button.classList.contains('delete-motoboy-btn')) {
                    App.deleteMotoboy(id);
                } else if (button.classList.contains('pay-motoboy-btn')) {
                    const amount = Number(button.dataset.amount);
                    const deliveryIds = JSON.parse(button.dataset.deliveryIds);
                    App.handlePayMotoboy(id, amount, deliveryIds);
                } else if (button.classList.contains('mark-delivered-btn')) {
                    const order = App.state.orders.find(o => o.id === id);
                    if (order?.is_delivery) {
                        App.openAssignMotoboyModal(id);
                    } else {
                        App.handleMarkAsDelivered(id);
                    }
                } else if (button.classList.contains('cancel-order-btn')) {
                    App.handleCancelOrder(id);
                } else if (button.classList.contains('edit-order-btn')) {
                    App.handleEditOrder(id);
                } else if (button.classList.contains('refund-order-btn')) {
                    App.showRefundConfirmation(button);
                } else if (button.classList.contains('cancel-refund-btn')) {
                    App.cancelRefundConfirmation(button);
                } else if (button.classList.contains('confirm-refund-btn')) {
                    App.handleRefundOrder(id, Number(value));
                } else if (button.classList.contains('delete-expense-btn')) {
                    App.deleteExpense(id);
                } else if (button.id === 'lancar-pedido-btn') {
                    App.openOrderModal();
                } else if (button.id === 'add-business-expense-btn') {
                    App.openExpenseModal('empresa');
                } else if (button.id === 'add-personal-expense-btn') {
                    App.openExpenseModal('pessoal');
                } else if (button.id === 'add-personal-income-btn') {
                    App.openPersonalIncomeModal();
                } else if (button.id === 'cancel-edit-customer-btn' || button.id === 'cancel-edit-product-btn' || button.id === 'cancel-edit-ingredient-btn' || button.id === 'cancel-edit-motoboy-btn') {
                    App.resetCustomerForm(); App.resetProductForm(); App.resetIngredientForm(); App.resetMotoboyForm();
                } else if (button.id === 'cancel-modal-btn' || button.id === 'cancel-assign-btn') {
                    App.closeAllModals();
                } else if (button.id === 'generate-ai-image-btn') {
                    App.generateImageWithAI();
                } else if (button.id === 'open-expense-importer-btn') {
                    App.openImageImportModal('expense');
                } else if (button.id === 'open-caixa-btn') {
                    App.openCashSessionModal('open');
                } else if (button.id === 'close-caixa-btn') {
                    App.openCashSessionModal('close');
                }
            }

            if (link) {
                e.preventDefault();
                const pageId = link.dataset.page;
                if (pageId) App.navigateTo(pageId);
            }
        });
        
        document.body.addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            if (form.id === 'customer-form') App.handleCustomerFormSubmit(e);
            else if (form.id === 'product-form') App.handleProductFormSubmit(e);
            else if (form.id === 'ingredient-form') App.handleIngredientFormSubmit(e);
            else if (form.id === 'motoboy-form') App.handleMotoboyFormSubmit(e);
            else if (form.id === 'finalize-order-form') App.handleFinalizeOrderSubmit(e);
            else if (form.id === 'modal-expense-form') App.handleExpenseFormSubmit(e);
            else if (form.id === 'modal-income-form') App.handlePersonalIncomeSubmit(e);
            else if (form.id === 'open-caixa-form') App.handleOpenCaixaSubmit(e);
            else if (form.id === 'close-caixa-form') App.handleCloseCaixaSubmit(e);
            else if (form.id === 'assign-motoboy-form') App.handleAssignMotoboy(e);
        });

        document.getElementById('product-image-upload')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                App.state.productFormImageFile = file;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const preview = document.getElementById('product-image-preview');
                    preview.src = event.target.result;
                    preview.classList.remove('hidden');
                    document.getElementById('product-image-placeholder').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // --- INICIALIZAÇÃO ---
        App.init = async () => {
            App.showLoading();
            App.updateUserInfo(App.state.currentUser);
            await App.loadData();
            
            viewModeToggle.addEventListener('change', (e) => {
                App.state.viewMode = e.target.checked ? 'pessoal' : 'empresa';
                App.updateViewMode();
            });
            
            notificationBellBtn.addEventListener('click', App.toggleNotifications);
            supportIconBtn.addEventListener('click', () => App.toggleChat(true));
            closeChatBtn.addEventListener('click', () => App.toggleChat(false));
            chatForm.addEventListener('submit', App.handleChatSubmit);

            App.navigateTo('dashboard');
            lucide.createIcons();
            App.hideLoading();
        };
    });
    </script>
</body>
</html>
